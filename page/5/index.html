<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
<script data-ad-client="ca-pub-1831623022964098" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/C_Meng.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/C_Meng.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/C_Meng.png">
  <link rel="mask-icon" href="/images/C_Meng.png" color="#222">
  <meta name="google-site-verification" content="-WnFIB8dOJwdL5b4iIfg6bNp1o-p5XnbyMIPVWXr6N0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"imonce.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人">
<meta property="og:type" content="website">
<meta property="og:title" content="C_Meng PSNA">
<meta property="og:url" content="https://imonce.github.io/page/5/index.html">
<meta property="og:site_name" content="C_Meng PSNA">
<meta property="og:description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="C_Meng PSNA">
<meta name="twitter:description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人">

<link rel="canonical" href="https://imonce.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'default'
  };
</script>

  <title>C_Meng PSNA</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">C_Meng PSNA</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Never wait for the storm to pass, just dance in the rain.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">215</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">32</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">140</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/imonce" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/11/28/多目标优化简述/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/28/多目标优化简述/" class="post-title-link" itemprop="url">多目标优化简述</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-28 21:14:53" itemprop="dateCreated datePublished" datetime="2019-11-28T21:14:53+08:00">2019-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-02 12:39:22" itemprop="dateModified" datetime="2019-12-02T12:39:22+08:00">2019-12-02</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/11/28/多目标优化简述/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/28/多目标优化简述/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <p>多目标优化是多准则决策的一个领域，它是涉及多个目标函数同时优化的数学问题。多目标优化已经应用于许多科学领域，包括工程、经济和物流，其中需要在两个或多个相互冲突的目标之间进行权衡的情况下作出最优决策。分别涉及两个和三个目标的多目标优化问题的例子有：在购买汽车时降低成本，同时使舒适性最大化；在使车辆的燃料消耗和污染物排放最小化的同时将性能最大化。在实际问题中，甚至可以有三多个目标。</p>
<p>对于非平凡多目标优化问题，不存在同时优化每个目标的单个解决方案。在这种情况下，目标函数被说成是冲突的，并且存在一个（可能无限）数量的帕累托最优解。如果目标函数在值上不能改进而不降低其他一些目标值，则解决方案称为非支配、Pareto最优、Pareto有效或非劣解。如果没有额外的主观偏好信息，所有Pareto最优解都被认为是同样好的（因为向量不能完全排序）。研究人员从不同的角度研究多目标优化问题，从而在设置和解决多目标优化问题时存在不同的求解哲学和目标。目标可以是找到帕累托最优解的代表性集合，and/or量化满足不同目标的折衷，and/or找到满足人类决策者decision maker(DM)的主观偏好的单一解决方案。</p>
<h1 id="形式化定义"><a href="#形式化定义" class="headerlink" title="形式化定义"></a>形式化定义</h1><p>$$<br>\begin{array}{cl}{\min / \max } &amp; {f_{m}(x), \quad m=1,2, \ldots, M} \\ {\text { subject to }} &amp; {g_{j}(x) \geq 0, \quad j=1,2, \ldots, J} \\ {} &amp; {h_{k}(x)=0, \quad k=1,2, \ldots, K} \\ {} &amp; {x_{i}^{(Lower)} \leq x_{i} \leq x_{i}^{(Upper)}, \quad i=1,2, \ldots, n} \end{array}<br>$$</p>
<h1 id="发展历史"><a href="#发展历史" class="headerlink" title="发展历史"></a>发展历史</h1><table>
<thead>
<tr>
<th>年份</th>
<th>事件</th>
<th>相关论文</th>
</tr>
</thead>
<tbody><tr>
<td>1906</td>
<td>Pareto提出核心思想</td>
<td>Pareto, V. (1906). Manuale di economia politica (Vol. 13). Societa Editrice.</td>
</tr>
<tr>
<td>1979</td>
<td>Stadler, W. 对帕累托最优进一步回顾</td>
<td>Stadler, W. (1979). A survey of multicriteria optimization or the vector maximum problem, part I: 1776–1960. Journal of Optimization Theory and Applications, 29(1), 1-52.</td>
</tr>
<tr>
<td>2008</td>
<td>Miettinen, K.提出一种混合方法解决多目标问题</td>
<td>Miettinen, K., Ruiz, F., &amp; Wierzbicki, A. P. (2008). Introduction to multiobjective optimization: interactive approaches. In Multiobjective Optimization (pp. 27-57). Springer, Berlin, Heidelberg.</td>
</tr>
<tr>
<td>2014</td>
<td>Deb, K.对多目标优化进行回顾</td>
<td>Deb, K. (2014). Multi-objective optimization. In Search methodologies (pp. 403-449). Springer, Boston, MA.</td>
</tr>
<tr>
<td>2018</td>
<td>Sener, O., &amp; Koltun, V.提出多任务学习来作为多目标优化的策略</td>
<td>Sener, O., &amp; Koltun, V. (2018). Multi-task learning as multi-objective optimization. In Advances in Neural Information Processing Systems (pp. 524-535).</td>
</tr>
</tbody></table>
<p>多目标优化算法归结起来有传统优化算法和智能优化算法两大类。</p>
<ol>
<li>传统优化算法包括加权法、约束法和线性规划法等，实质上就是将多目标函数转化为单目标函数，通过采用单目标优化的方法达到对多目标函数的求解。 </li>
<li>智能优化算法包括进化算法（Evolutionary Algorithm, 简称EA）、粒子群算法（Particle Swarm Optimization, PSO）等。</li>
</ol>
<p>从九十年代初开始，进化算法系列算法被统一，如遗传算法等。</p>
<h1 id="多目标优化问题的解"><a href="#多目标优化问题的解" class="headerlink" title="多目标优化问题的解"></a>多目标优化问题的解</h1><p>在单目标优化问题中，通常最优解只有一个，而且能用比较简单和常用的数学方法求出其最优解。然而在多目标优化问题中，各个目标之间相互制约，可能使得一个目标性能的改善往往是以损失其它目标性能为代价，不可能存在一个使所有目标性能都达到最优的解，所以对于多目标优化问题，其解通常是一个非劣解的集合——Pareto解集。</p>
<blockquote>
<p>帕累托最优（Pareto Optimal）：帕雷托最优是指资源分配的一种理想状态。给定固有的一群人和可分配的资源，如果从一种分配状态到另一种状态的变化中，在没有使任何人境况变坏的前提下，使得至少一个人变得更好，这就是帕雷托改善。帕雷托最优的状态就是不可能再有更多的帕雷托改善的状态；换句话说，不可能在不使任何其他人受损的情况下再改善某些人的境况。帕累托最优解集的边界（boundary）被称为帕累托最优前沿面（Pareto-optimal front）。</p>
</blockquote>
<p>在存在多个Pareto最优解的情况下，如果没有关于问题的更多的信息，那么很难选择哪个解更可取，因此所有的Pareto最优解都可以被认为是同等重要的。由此可知，对于多目标优化问题，最重要的任务是找到尽可能多的关于该优化问题的Pareto最优解。因而，在多目标优化中主要完成以下两个任务：</p>
<ol>
<li>找到一组尽可能接近Pareto最优域的解。</li>
<li>找到一组尽可能不同的解。</li>
</ol>
<p>第一个任务是在任何优化工作中都必须的做到的，收敛不到接近真正Pareto最优解集的解是不可取的，只有当一组解收敛到接近真正Pareto最优解，才能确保该组解近似最优的这一特性。</p>
<h1 id="几种常用的多目标优化问题解决方法"><a href="#几种常用的多目标优化问题解决方法" class="headerlink" title="几种常用的多目标优化问题解决方法"></a>几种常用的多目标优化问题解决方法</h1><h2 id="Weighted-Sum-Method"><a href="#Weighted-Sum-Method" class="headerlink" title="Weighted Sum Method"></a>Weighted Sum Method</h2><p>线性加权法，其中权重代表了每个目标函数的重要程度。</p>
<p>$$<br>\begin{array}{rl}{\min } &amp; {F(x)=\sum_{m=1}^{M} w_{m} f_{m}(x)} \\ {\text { subject to }} &amp; {g_{j}(x) \geq 0, \quad j=1,2, \ldots, J} \\ {} &amp; {h_{k}(x)=0, \quad k=1,2, \ldots, K} \\ {} &amp; {x_{i}^{(Lower)} \leq x_{i} \leq x_{i}^{(Upper)}, \quad i=1,2, \ldots, n}\end{array}<br>$$</p>
<p>优点：简单</p>
<p>缺点：很难设定一个权重向量能够去获得帕累托最优解；在一些非凸情况不能够保证获得帕累托最优解</p>
<h2 id="varepsilon-constraint-method"><a href="#varepsilon-constraint-method" class="headerlink" title="$\varepsilon$ -constraint method"></a>$\varepsilon$ -constraint method</h2><p>只保留一个目标函数，其他的目标函数被设定的值约束。</p>
<p>$$<br>\begin{array}{cl}{\min } &amp; {f_{\mu}(x)} \\ {\text {subject to }} &amp; {f_{m}(x) \leq \epsilon_{m}, \quad m=1,2, \ldots, M \text { and } m \neq \mu} \\ {} &amp; {g_{j}(x) \geq 0, \quad j=1,2, \ldots, J} \\ {} &amp; {h_{k}(x)=0,} \quad {k=1,2, \ldots, K} \\ {} &amp; {x_{i}^{(Lower)} \leq x_{i} \leq x_{i}^{(Upper)},} \quad {i=1,2, \ldots, n}\end{array}<br>$$</p>
<p>优点：能够应用到凸函数和非凸函数场景下</p>
<p>缺点：函数需要精心选择；需要在独立目标函数的最小值或最大值之内</p>
<h2 id="Weighted-Metric-Method"><a href="#Weighted-Metric-Method" class="headerlink" title="Weighted Metric Method"></a>Weighted Metric Method</h2><p>$$<br>\begin{array}{cl}{\min } &amp; {l_{p}(x)=\left(\sum_{m=1}^{M} w_{m}\left|f_{m}(x)-z_{m}^{*}\right|\right)^{1 / p}} \\ {\text { subject to }} &amp; {g_{j}(x) \geq 0, \quad j=1,2, \ldots, J} \\ {} &amp; {h_{k}(x)=0, \quad k=1,2, \ldots, K} \\ {} &amp; {x_{i}^{(Lower)} \leq x_{i} \leq x_{i}^{(Upper)}, \quad i=1,2, \ldots, n}\end{array}<br>$$</p>
<p>优点：weighted Techebycheff metirc能够保证获得所有帕累托最优解</p>
<p>缺点：需要有每个函数最大值和最小值的先验知识；需要每个目标函数的 $z^{*}$ 能够独立被找到；对于较小的p值，不一定保证所有能够获得所有帕累托最优解；随着p增加，问题会变得不可求导</p>
<h2 id="Multi-Objective-Genetic-Algorithms"><a href="#Multi-Objective-Genetic-Algorithms" class="headerlink" title="Multi-Objective Genetic Algorithms"></a>Multi-Objective Genetic Algorithms</h2><p>基于遗传算法的多目标优化就是利用遗传算法的原理来搜索帕累托最优前沿面。</p>
<p>遗传算法相比与传统算法的优点是能够得到一个最优解集，而不是单单一个最优解，这样给我们更多的选择。但计算复杂度可能稍高，而且里面涉及的一些函数需要精心设计。</p>
<p>详见：<a href="https://imonce.github.io/2019/11/07/%E5%90%AF%E5%8F%91%E5%BC%8F%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E9%81%97%E4%BC%A0%E7%AE%97%E6%B3%95/">https://imonce.github.io/2019/11/07/启发式算法学习（三）：遗传算法/</a></p>
<h1 id="发展分析"><a href="#发展分析" class="headerlink" title="发展分析"></a>发展分析</h1><p>多目标优化算法相对成熟，在不同的问题使用不同的优化算法。NSGA-II, SPEA 或者 MOPSO都是可选项，而到底选择哪一个方法，还需要根据特定的情景选择。</p>
<p>尽管多目标优化算法应用于动态的制造系统，dynamic manufacturing systems，但是制造系统和很复杂的，并且是动态的，因此算法还是有一定的缺陷性。</p>
<p>未来发展方向：</p>
<ol>
<li><p>因为多种多目标方法已经被提出，混合方法 hybrid method可以被进一步发展。</p>
</li>
<li><p>现在的动态制造系统中的多目标优化算法需要动态调度的能力</p>
</li>
</ol>
<blockquote>
<p>Reference:<br><a href="https://www.jiqizhixin.com/graph/technologies/cf8932be-519a-4fd9-84f9-c6ffa997a554" target="_blank" rel="noopener">https://www.jiqizhixin.com/graph/technologies/cf8932be-519a-4fd9-84f9-c6ffa997a554</a><br><a href="https://blog.csdn.net/paulfeng20171114/article/details/82454310" target="_blank" rel="noopener">https://blog.csdn.net/paulfeng20171114/article/details/82454310</a><br><a href="https://hpzhao.github.io/2018/09/17/%E5%A4%9A%E7%9B%AE%E6%A0%87%E4%BC%98%E5%8C%96%E5%9B%9B%E7%A7%8D%E6%96%B9%E6%B3%95/" target="_blank" rel="noopener">https://hpzhao.github.io/2018/09/17/多目标优化四种方法/</a><br><a href="https://zh.wikipedia.org/wiki/%E5%B8%95%E7%B4%AF%E6%89%98%E6%9C%80%E4%BC%98" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/帕累托最优</a></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/11/08/启发式算法学习（四）：蚁群算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/08/启发式算法学习（四）：蚁群算法/" class="post-title-link" itemprop="url">启发式算法学习（四）：蚁群算法ACO</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-08 09:30:15" itemprop="dateCreated datePublished" datetime="2019-11-08T09:30:15+08:00">2019-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-30 20:27:59" itemprop="dateModified" datetime="2019-12-30T20:27:59+08:00">2019-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/启发式算法/" itemprop="url" rel="index"><span itemprop="name">启发式算法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/11/08/启发式算法学习（四）：蚁群算法/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/08/启发式算法学习（四）：蚁群算法/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <h1 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h1><p>蚁群算法（<strong>Ant Colony Algorithm, AG</strong>, or <strong>Ant Colony Optimization, ACO</strong>），又称蚂蚁算法，是一种用来在图中寻找优化路径的机率型算法。它由Marco Dorigo于1992年在他的博士论文“Ant system: optimization by a colony of cooperating agents”中提出，其灵感来源于蚂蚁在寻找食物过程中发现路径的行为。蚁群算法是一种模拟进化算法，初步的研究表明该算法具有许多优良的性质。针对PID控制器参数优化设计问题，将蚁群算法设计的结果与遗传算法设计的结果进行了比较，数值仿真结果表明，蚁群算法具有一种新的模拟进化优化方法的有效性和应用价值。</p>
<h1 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h1><p>蚂蚁会在其经过的路径上释放一种可以称之为“信息素”的物质，蚁群内的蚂蚁对“信息素”具有感知能力，它们会沿着“信息素”浓度较高路径行走，而每只路过的蚂蚁都会在路上留下“信息素”，这就形成一种类似正反馈的机制，这样经过一段时间后，整个蚁群就会沿着最短路径到达食物源了。可以分解为以下几步：</p>
<ol>
<li>蚂蚁在路径上释放信息素。</li>
<li>碰到还没走过的路口，就随机挑选一条路走。同时，释放与路径长度有关的信息素。</li>
<li>信息素浓度与路径长度成反比。后来的蚂蚁再次碰到该路口时，就选择信息素浓度较高路径。</li>
<li>最优路径上的信息素浓度越来越大。</li>
<li>最终蚁群找到最优寻食路径。</li>
</ol>
<h1 id="算法流程"><a href="#算法流程" class="headerlink" title="算法流程"></a>算法流程</h1><p>蚁群算法解决旅行商问题的流程：</p>
<div id="flowchart-0" class="flow-chart"></div>

<h1 id="数学模型"><a href="#数学模型" class="headerlink" title="数学模型"></a>数学模型</h1><p>这个利用TSP问题来说明这个数学模型，对于TSP问题，设蚂蚁群体中蚂蚁的数量为m，城市的数量为n，城市i与城市j之间的距离为 $d_{ij}$ ，t时刻城市i与城市j连接路径上的信息素浓度为 $c_{ij}(t)$ 。初始时刻，蚂蚁被放置在不同的城市里，且各城市键连接路径上的信息素浓度相同。然后蚂蚁将按一定概率选择线路，不放设 $p^k_{ij}(t)$ 为t时刻蚂蚁k从城市i转移到城市j的概率。“蚂蚁TSP”策略收到两方面的左右，首先是访问某城市的期望，领完便是其他蚂蚁释放的信息素浓度。所以已定义：</p>
<p>$$p_{ij}^{k}(t)=\left\lbrace\begin{array}{cll}<br>\frac{[c_{ij}(t)]^{a} * [n_{ij}(t)]^{b}}{\sum [c_{ij}(t)]^{a} * [n_{ij}(t)]^{b}} &amp; , &amp; j \in allowk \\<br>0 &amp; , &amp; j \notin allowk<br>\end{array}\right.$$</p>
<p>其中：</p>
<ul>
<li>$n_{ij}(t)$ 为启发函数，表示蚂蚁从城市i转移到城市j的期望</li>
<li>$allowk$ 为蚂蚁带访问城市集合，开始时， $allowk$ 中有 $n−1$ 个元素，即包括除了蚂蚁k出发城市的其他多个城市，随着时间的推移， $allowk$ 中的元素越来越少，直至为空</li>
<li>$a$ 为信息素重要程度因子</li>
<li>$b$ 为启发函数因子</li>
</ul>
<p>在蚂蚁遍历各城市的过程中，与实际情况相似的是，在蚂蚁释放信息素的同事，各个城市之间连接路径上的信息素的强度也在通过挥发等方式逐渐消失。为了描述这个特征，设ρ表示信息素挥发程度。这样所有蚂蚁完成走完一遍所有城市之后，各个城市键连接路径上的信息素浓度为</p>
<p>$$c_{ij}(t+1) = (1-\rho)*c_{ij}(t) + \Delta c_{ij}$$</p>
<p>$$\Delta c_{ij} = \sum \Delta c^k_{ij}$$</p>
<p>$\Delta c^k_{ij}$ 为第k只蚂蚁在城市i与城市j连接路径上释放信息素而增加的信息素浓度。</p>
<p>$\Delta c_{ij}$ 为所有蚂蚁在城市i与城市j连接路径上释放信息素而增加的信息素浓度。</p>
<p>一般情况下 $\Delta c^k_{ij}=\frac{Q}{L_k}$ ,若蚂蚁k从城市i访问了城市j，其中 $Q$ 为信息素常数， $L_k$ 为第k只蚂蚁经过路径总长度。</p>
<h1 id="python代码"><a href="#python代码" class="headerlink" title="python代码"></a>python代码</h1><p>代码来源：<a href="https://blog.csdn.net/fanxin_i/article/details/80380733" target="_blank" rel="noopener">https://blog.csdn.net/fanxin_i/article/details/80380733</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> tkinter <span class="comment">#//GUI模块</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 参数</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">ALPHA:信息启发因子，值越大，则蚂蚁选择之前走过的路径可能性就越大</span></span><br><span class="line"><span class="string">      ，值越小，则蚁群搜索范围就会减少，容易陷入局部最优</span></span><br><span class="line"><span class="string">BETA:Beta值越大，蚁群越就容易选择局部较短路径，这时算法收敛速度会</span></span><br><span class="line"><span class="string">     加快，但是随机性不高，容易得到局部的相对最优</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">(ALPHA, BETA, RHO, Q) = (<span class="number">1.0</span>,<span class="number">2.0</span>,<span class="number">0.5</span>,<span class="number">100.0</span>)</span><br><span class="line"><span class="comment"># 城市数，蚁群</span></span><br><span class="line">(city_num, ant_num) = (<span class="number">50</span>,<span class="number">50</span>)</span><br><span class="line">distance_x = [</span><br><span class="line">    <span class="number">178</span>,<span class="number">272</span>,<span class="number">176</span>,<span class="number">171</span>,<span class="number">650</span>,<span class="number">499</span>,<span class="number">267</span>,<span class="number">703</span>,<span class="number">408</span>,<span class="number">437</span>,<span class="number">491</span>,<span class="number">74</span>,<span class="number">532</span>,</span><br><span class="line">    <span class="number">416</span>,<span class="number">626</span>,<span class="number">42</span>,<span class="number">271</span>,<span class="number">359</span>,<span class="number">163</span>,<span class="number">508</span>,<span class="number">229</span>,<span class="number">576</span>,<span class="number">147</span>,<span class="number">560</span>,<span class="number">35</span>,<span class="number">714</span>,</span><br><span class="line">    <span class="number">757</span>,<span class="number">517</span>,<span class="number">64</span>,<span class="number">314</span>,<span class="number">675</span>,<span class="number">690</span>,<span class="number">391</span>,<span class="number">628</span>,<span class="number">87</span>,<span class="number">240</span>,<span class="number">705</span>,<span class="number">699</span>,<span class="number">258</span>,</span><br><span class="line">    <span class="number">428</span>,<span class="number">614</span>,<span class="number">36</span>,<span class="number">360</span>,<span class="number">482</span>,<span class="number">666</span>,<span class="number">597</span>,<span class="number">209</span>,<span class="number">201</span>,<span class="number">492</span>,<span class="number">294</span>]</span><br><span class="line">distance_y = [</span><br><span class="line">    <span class="number">170</span>,<span class="number">395</span>,<span class="number">198</span>,<span class="number">151</span>,<span class="number">242</span>,<span class="number">556</span>,<span class="number">57</span>,<span class="number">401</span>,<span class="number">305</span>,<span class="number">421</span>,<span class="number">267</span>,<span class="number">105</span>,<span class="number">525</span>,</span><br><span class="line">    <span class="number">381</span>,<span class="number">244</span>,<span class="number">330</span>,<span class="number">395</span>,<span class="number">169</span>,<span class="number">141</span>,<span class="number">380</span>,<span class="number">153</span>,<span class="number">442</span>,<span class="number">528</span>,<span class="number">329</span>,<span class="number">232</span>,<span class="number">48</span>,</span><br><span class="line">    <span class="number">498</span>,<span class="number">265</span>,<span class="number">343</span>,<span class="number">120</span>,<span class="number">165</span>,<span class="number">50</span>,<span class="number">433</span>,<span class="number">63</span>,<span class="number">491</span>,<span class="number">275</span>,<span class="number">348</span>,<span class="number">222</span>,<span class="number">288</span>,</span><br><span class="line">    <span class="number">490</span>,<span class="number">213</span>,<span class="number">524</span>,<span class="number">244</span>,<span class="number">114</span>,<span class="number">104</span>,<span class="number">552</span>,<span class="number">70</span>,<span class="number">425</span>,<span class="number">227</span>,<span class="number">331</span>]</span><br><span class="line"><span class="comment">#城市距离和信息素</span></span><br><span class="line">distance_graph = [ [<span class="number">0.0</span> <span class="keyword">for</span> col <span class="keyword">in</span> range(city_num)] <span class="keyword">for</span> raw <span class="keyword">in</span> range(city_num)]</span><br><span class="line">pheromone_graph = [ [<span class="number">1.0</span> <span class="keyword">for</span> col <span class="keyword">in</span> range(city_num)] <span class="keyword">for</span> raw <span class="keyword">in</span> range(city_num)]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#----------- 蚂蚁 -----------</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ant</span><span class="params">(object)</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,ID)</span>:</span></span><br><span class="line">        </span><br><span class="line">        self.ID = ID                 <span class="comment"># ID</span></span><br><span class="line">        self.__clean_data()          <span class="comment"># 随机初始化出生点</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 初始数据</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__clean_data</span><span class="params">(self)</span>:</span></span><br><span class="line">    </span><br><span class="line">        self.path = []               <span class="comment"># 当前蚂蚁的路径           </span></span><br><span class="line">        self.total_distance = <span class="number">0.0</span>    <span class="comment"># 当前路径的总距离</span></span><br><span class="line">        self.move_count = <span class="number">0</span>          <span class="comment"># 移动次数</span></span><br><span class="line">        self.current_city = <span class="number">-1</span>       <span class="comment"># 当前停留的城市</span></span><br><span class="line">        self.open_table_city = [<span class="keyword">True</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(city_num)] <span class="comment"># 探索城市的状态</span></span><br><span class="line">        </span><br><span class="line">        city_index = random.randint(<span class="number">0</span>,city_num<span class="number">-1</span>) <span class="comment"># 随机初始出生点</span></span><br><span class="line">        self.current_city = city_index</span><br><span class="line">        self.path.append(city_index)</span><br><span class="line">        self.open_table_city[city_index] = <span class="keyword">False</span></span><br><span class="line">        self.move_count = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 选择下一个城市</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__choice_next_city</span><span class="params">(self)</span>:</span></span><br><span class="line">        </span><br><span class="line">        next_city = <span class="number">-1</span></span><br><span class="line">        select_citys_prob = [<span class="number">0.0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(city_num)]  <span class="comment">#存储去下个城市的概率</span></span><br><span class="line">        total_prob = <span class="number">0.0</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 获取去下一个城市的概率</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(city_num):</span><br><span class="line">            <span class="keyword">if</span> self.open_table_city[i]:</span><br><span class="line">                <span class="keyword">try</span> :</span><br><span class="line">                    <span class="comment"># 计算概率：与信息素浓度成正比，与距离成反比</span></span><br><span class="line">                    select_citys_prob[i] = pow(pheromone_graph[self.current_city][i], ALPHA) * pow((<span class="number">1.0</span>/distance_graph[self.current_city][i]), BETA)</span><br><span class="line">                    total_prob += select_citys_prob[i]</span><br><span class="line">                <span class="keyword">except</span> ZeroDivisionError <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="keyword">print</span> (<span class="string">'Ant ID: &#123;ID&#125;, current city: &#123;current&#125;, target city: &#123;target&#125;'</span>.format(ID = self.ID, current = self.current_city, target = i))</span><br><span class="line">                    sys.exit(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 轮盘选择城市</span></span><br><span class="line">        <span class="keyword">if</span> total_prob &gt; <span class="number">0.0</span>:</span><br><span class="line">            <span class="comment"># 产生一个随机概率,0.0-total_prob</span></span><br><span class="line">            temp_prob = random.uniform(<span class="number">0.0</span>, total_prob)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(city_num):</span><br><span class="line">                <span class="keyword">if</span> self.open_table_city[i]:</span><br><span class="line">                    <span class="comment"># 轮次相减</span></span><br><span class="line">                    temp_prob -= select_citys_prob[i]</span><br><span class="line">                    <span class="keyword">if</span> temp_prob &lt; <span class="number">0.0</span>:</span><br><span class="line">                        next_city = i</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 未从概率产生，顺序选择一个未访问城市</span></span><br><span class="line">        <span class="comment"># if next_city == -1:</span></span><br><span class="line">        <span class="comment">#     for i in range(city_num):</span></span><br><span class="line">        <span class="comment">#         if self.open_table_city[i]:</span></span><br><span class="line">        <span class="comment">#             next_city = i</span></span><br><span class="line">        <span class="comment">#             break</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (next_city == <span class="number">-1</span>):</span><br><span class="line">            next_city = random.randint(<span class="number">0</span>, city_num - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">while</span> ((self.open_table_city[next_city]) == <span class="keyword">False</span>):  <span class="comment"># if==False,说明已经遍历过了</span></span><br><span class="line">                next_city = random.randint(<span class="number">0</span>, city_num - <span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 返回下一个城市序号</span></span><br><span class="line">        <span class="keyword">return</span> next_city</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算路径总距离</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__cal_total_distance</span><span class="params">(self)</span>:</span></span><br><span class="line">        </span><br><span class="line">        temp_distance = <span class="number">0.0</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, city_num):</span><br><span class="line">            start, end = self.path[i], self.path[i<span class="number">-1</span>]</span><br><span class="line">            temp_distance += distance_graph[start][end]</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 回路</span></span><br><span class="line">        end = self.path[<span class="number">0</span>]</span><br><span class="line">        temp_distance += distance_graph[start][end]</span><br><span class="line">        self.total_distance = temp_distance</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 移动操作</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__move</span><span class="params">(self, next_city)</span>:</span></span><br><span class="line">        </span><br><span class="line">        self.path.append(next_city)</span><br><span class="line">        self.open_table_city[next_city] = <span class="keyword">False</span></span><br><span class="line">        self.total_distance += distance_graph[self.current_city][next_city]</span><br><span class="line">        self.current_city = next_city</span><br><span class="line">        self.move_count += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 搜索路径</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search_path</span><span class="params">(self)</span>:</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 初始化数据</span></span><br><span class="line">        self.__clean_data()</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 搜素路径，遍历完所有城市为止</span></span><br><span class="line">        <span class="keyword">while</span> self.move_count &lt; city_num:</span><br><span class="line">            <span class="comment"># 移动到下一个城市</span></span><br><span class="line">            next_city =  self.__choice_next_city()</span><br><span class="line">            self.__move(next_city)</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 计算路径总长度</span></span><br><span class="line">        self.__cal_total_distance()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#----------- TSP问题 -----------</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TSP</span><span class="params">(object)</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, root, width = <span class="number">800</span>, height = <span class="number">600</span>, n = city_num)</span>:</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 创建画布</span></span><br><span class="line">        self.root = root                               </span><br><span class="line">        self.width = width      </span><br><span class="line">        self.height = height</span><br><span class="line">        <span class="comment"># 城市数目初始化为city_num</span></span><br><span class="line">        self.n = n</span><br><span class="line">        <span class="comment"># tkinter.Canvas</span></span><br><span class="line">        self.canvas = tkinter.Canvas(</span><br><span class="line">                root,</span><br><span class="line">                width = self.width,</span><br><span class="line">                height = self.height,</span><br><span class="line">                bg = <span class="string">"#EBEBEB"</span>,             <span class="comment"># 背景白色 </span></span><br><span class="line">                xscrollincrement = <span class="number">1</span>,</span><br><span class="line">                yscrollincrement = <span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">        self.canvas.pack(expand = tkinter.YES, fill = tkinter.BOTH)</span><br><span class="line">        self.title(<span class="string">"TSP蚁群算法(n:初始化 e:开始搜索 s:停止搜索 q:退出程序)"</span>)</span><br><span class="line">        self.__r = <span class="number">5</span></span><br><span class="line">        self.__lock = threading.RLock()     <span class="comment"># 线程锁</span></span><br><span class="line"> </span><br><span class="line">        self.__bindEvents()</span><br><span class="line">        self.new()</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 计算城市之间的距离</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(city_num):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(city_num):</span><br><span class="line">                temp_distance = pow((distance_x[i] - distance_x[j]), <span class="number">2</span>) + pow((distance_y[i] - distance_y[j]), <span class="number">2</span>)</span><br><span class="line">                temp_distance = pow(temp_distance, <span class="number">0.5</span>)</span><br><span class="line">                distance_graph[i][j] =float(int(temp_distance + <span class="number">0.5</span>))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 按键响应程序</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__bindEvents</span><span class="params">(self)</span>:</span></span><br><span class="line"> </span><br><span class="line">        self.root.bind(<span class="string">"q"</span>, self.quite)        <span class="comment"># 退出程序</span></span><br><span class="line">        self.root.bind(<span class="string">"n"</span>, self.new)          <span class="comment"># 初始化</span></span><br><span class="line">        self.root.bind(<span class="string">"e"</span>, self.search_path)  <span class="comment"># 开始搜索</span></span><br><span class="line">        self.root.bind(<span class="string">"s"</span>, self.stop)         <span class="comment"># 停止搜索</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 更改标题</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">title</span><span class="params">(self, s)</span>:</span></span><br><span class="line"> </span><br><span class="line">        self.root.title(s)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(self, evt = None)</span>:</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 停止线程</span></span><br><span class="line">        self.__lock.acquire()</span><br><span class="line">        self.__running = <span class="keyword">False</span></span><br><span class="line">        self.__lock.release()</span><br><span class="line"> </span><br><span class="line">        self.clear()     <span class="comment"># 清除信息 </span></span><br><span class="line">        self.nodes = []  <span class="comment"># 节点坐标</span></span><br><span class="line">        self.nodes2 = [] <span class="comment"># 节点对象</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 初始化城市节点</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(distance_x)):</span><br><span class="line">            <span class="comment"># 在画布上随机初始坐标</span></span><br><span class="line">            x = distance_x[i]</span><br><span class="line">            y = distance_y[i]</span><br><span class="line">            self.nodes.append((x, y))</span><br><span class="line">            <span class="comment"># 生成节点椭圆，半径为self.__r</span></span><br><span class="line">            node = self.canvas.create_oval(x - self.__r,</span><br><span class="line">                    y - self.__r, x + self.__r, y + self.__r,</span><br><span class="line">                    fill = <span class="string">"#ff0000"</span>,      <span class="comment"># 填充红色</span></span><br><span class="line">                    outline = <span class="string">"#000000"</span>,   <span class="comment"># 轮廓白色</span></span><br><span class="line">                    tags = <span class="string">"node"</span>,</span><br><span class="line">                )</span><br><span class="line">            self.nodes2.append(node)</span><br><span class="line">            <span class="comment"># 显示坐标</span></span><br><span class="line">            self.canvas.create_text(x,y<span class="number">-10</span>,              <span class="comment"># 使用create_text方法在坐标（302，77）处绘制文字</span></span><br><span class="line">                    text = <span class="string">'('</span>+str(x)+<span class="string">','</span>+str(y)+<span class="string">')'</span>,    <span class="comment"># 所绘制文字的内容</span></span><br><span class="line">                    fill = <span class="string">'black'</span>                       <span class="comment"># 所绘制文字的颜色为灰色</span></span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line">        <span class="comment"># 顺序连接城市</span></span><br><span class="line">        <span class="comment">#self.line(range(city_num))</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始城市之间的距离和信息素</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(city_num):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(city_num):</span><br><span class="line">                pheromone_graph[i][j] = <span class="number">1.0</span></span><br><span class="line">                </span><br><span class="line">        self.ants = [Ant(ID) <span class="keyword">for</span> ID <span class="keyword">in</span> range(ant_num)]  <span class="comment"># 初始蚁群</span></span><br><span class="line">        self.best_ant = Ant(<span class="number">-1</span>)                          <span class="comment"># 初始最优解</span></span><br><span class="line">        self.best_ant.total_distance = <span class="number">1</span> &lt;&lt; <span class="number">31</span>           <span class="comment"># 初始最大距离</span></span><br><span class="line">        self.iter = <span class="number">1</span>                                    <span class="comment"># 初始化迭代次数 </span></span><br><span class="line">            </span><br><span class="line">    <span class="comment"># 将节点按order顺序连线</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">line</span><span class="params">(self, order)</span>:</span></span><br><span class="line">        <span class="comment"># 删除原线</span></span><br><span class="line">        self.canvas.delete(<span class="string">"line"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">line2</span><span class="params">(i1, i2)</span>:</span></span><br><span class="line">            p1, p2 = self.nodes[i1], self.nodes[i2]</span><br><span class="line">            self.canvas.create_line(p1, p2, fill = <span class="string">"#000000"</span>, tags = <span class="string">"line"</span>)</span><br><span class="line">            <span class="keyword">return</span> i2</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># order[-1]为初始值</span></span><br><span class="line">        reduce(line2, order, order[<span class="number">-1</span>])</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 清除画布</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.canvas.find_all():</span><br><span class="line">            self.canvas.delete(item)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 退出程序</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quite</span><span class="params">(self, evt)</span>:</span></span><br><span class="line">        self.__lock.acquire()</span><br><span class="line">        self.__running = <span class="keyword">False</span></span><br><span class="line">        self.__lock.release()</span><br><span class="line">        self.root.destroy()</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">u"\n程序已退出..."</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 停止搜索</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self, evt)</span>:</span></span><br><span class="line">        self.__lock.acquire()</span><br><span class="line">        self.__running = <span class="keyword">False</span></span><br><span class="line">        self.__lock.release()</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 开始搜索</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">search_path</span><span class="params">(self, evt = None)</span>:</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 开启线程</span></span><br><span class="line">        self.__lock.acquire()</span><br><span class="line">        self.__running = <span class="keyword">True</span></span><br><span class="line">        self.__lock.release()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> self.__running:</span><br><span class="line">            <span class="comment"># 遍历每一只蚂蚁</span></span><br><span class="line">            <span class="keyword">for</span> ant <span class="keyword">in</span> self.ants:</span><br><span class="line">                <span class="comment"># 搜索一条路径</span></span><br><span class="line">                ant.search_path()</span><br><span class="line">                <span class="comment"># 与当前最优蚂蚁比较</span></span><br><span class="line">                <span class="keyword">if</span> ant.total_distance &lt; self.best_ant.total_distance:</span><br><span class="line">                    <span class="comment"># 更新最优解</span></span><br><span class="line">                    self.best_ant = copy.deepcopy(ant)</span><br><span class="line">            <span class="comment"># 更新信息素</span></span><br><span class="line">            self.__update_pheromone_gragh()</span><br><span class="line">            <span class="keyword">print</span> (<span class="string">u"迭代次数："</span>,self.iter,<span class="string">u"最佳路径总距离："</span>,int(self.best_ant.total_distance))</span><br><span class="line">            <span class="comment"># 连线</span></span><br><span class="line">            self.line(self.best_ant.path)</span><br><span class="line">            <span class="comment"># 设置标题</span></span><br><span class="line">            self.title(<span class="string">"TSP蚁群算法(n:随机初始 e:开始搜索 s:停止搜索 q:退出程序) 迭代次数: %d"</span> % self.iter)</span><br><span class="line">            <span class="comment"># 更新画布</span></span><br><span class="line">            self.canvas.update()</span><br><span class="line">            self.iter += <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 更新信息素</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__update_pheromone_gragh</span><span class="params">(self)</span>:</span></span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 获取每只蚂蚁在其路径上留下的信息素</span></span><br><span class="line">        temp_pheromone = [[<span class="number">0.0</span> <span class="keyword">for</span> col <span class="keyword">in</span> range(city_num)] <span class="keyword">for</span> raw <span class="keyword">in</span> range(city_num)]</span><br><span class="line">        <span class="keyword">for</span> ant <span class="keyword">in</span> self.ants:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,city_num):</span><br><span class="line">                start, end = ant.path[i<span class="number">-1</span>], ant.path[i]</span><br><span class="line">                <span class="comment"># 在路径上的每两个相邻城市间留下信息素，与路径总距离反比</span></span><br><span class="line">                temp_pheromone[start][end] += Q / ant.total_distance</span><br><span class="line">                temp_pheromone[end][start] = temp_pheromone[start][end]</span><br><span class="line"> </span><br><span class="line">        <span class="comment"># 更新所有城市之间的信息素，旧信息素衰减加上新迭代信息素</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(city_num):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(city_num):</span><br><span class="line">                pheromone_graph[i][j] = pheromone_graph[i][j] * RHO + temp_pheromone[i][j]</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 主循环</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mainloop</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.root.mainloop()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#----------- 程序的入口处 -----------</span></span><br><span class="line">                </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"> </span><br><span class="line">    TSP(tkinter.Tk()).mainloop()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Reference:<br><a href="https://zh.wikipedia.org/wiki/%E8%9A%81%E7%BE%A4%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/蚁群算法</a><br><a href="https://blog.csdn.net/fanxin_i/article/details/80380733" target="_blank" rel="noopener">https://blog.csdn.net/fanxin_i/article/details/80380733</a><br><a href="https://blog.csdn.net/qq_35109096/article/details/81126925" target="_blank" rel="noopener">https://blog.csdn.net/qq_35109096/article/details/81126925</a><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: Start
op1=>operation: 初始化
op15=>operation: 随机放置蚂蚁
op2=>operation: 对每只蚂蚁选择下个城市
op3=>operation: 更新信息素
op4=>operation: 输出最好路径
cond1=>condition: 还有城市可选？
cond2=>condition: 达到最大迭代次数？
ed=>end: End
st->op1->op15->op2->cond1(no)->op3->cond2(yes)->ed
cond1(yes)->op2
cond2(no)->op15</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/11/07/启发式算法学习（三）：遗传算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/07/启发式算法学习（三）：遗传算法/" class="post-title-link" itemprop="url">启发式算法学习（三）：遗传算法GA</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-07 10:26:36" itemprop="dateCreated datePublished" datetime="2019-11-07T10:26:36+08:00">2019-11-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-24 11:20:28" itemprop="dateModified" datetime="2022-06-24T11:20:28+08:00">2022-06-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/启发式算法/" itemprop="url" rel="index"><span itemprop="name">启发式算法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/11/07/启发式算法学习（三）：遗传算法/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/07/启发式算法学习（三）：遗传算法/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <h1 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h1><p>遗传算法（Genetic Alogrithm，GA）是最早由美国Holland教授提出的一种基于自然界的“适者生存，优胜劣汰”基本法则的智能搜索算法。该法则很好地诠释了生物进化的自然选择过程。遗传算法也是借鉴该基本法则，通过基于种群的思想，将问题的解通过编码的方式转化为种群中的个体，并让这些个体不断地通过选择、交叉和变异算子模拟生物的进化过程，然后利用“优胜劣汰”法则选择种群中适应性较强的个体构成子种群，然后让子种群重复类似的进化过程，直到找到问题的最优解或者到达一定的进化（运算）时间。</p>
<h1 id="重要概念"><a href="#重要概念" class="headerlink" title="重要概念"></a>重要概念</h1><p>个体（染色体）：自然界中一个个体（染色体）代表一个生物，在GA算法中，个体（染色体）代表了具体问题的一个解。</p>
<p>基因：在GA算法中，基因代表了具体问题解的一个决策变量，问题解和染色体中基因的对应关系如下所示</p>
<p><img src="https://raw.githubusercontent.com/imonce/imgs/master/20191107142629.png"></p>
<p>种群：多个个体即组成一个种群。GA算法中，一个问题的多组解即构成了问题的解的种群。</p>
<h1 id="主要步骤"><a href="#主要步骤" class="headerlink" title="主要步骤"></a>主要步骤</h1><div id="flowchart-0" class="flow-chart"></div>

<h1 id="主要操作介绍"><a href="#主要操作介绍" class="headerlink" title="主要操作介绍"></a>主要操作介绍</h1><h2 id="种群的初始化"><a href="#种群的初始化" class="headerlink" title="种群的初始化"></a>种群的初始化</h2><p>选择一种编码方案，然后在解空间内通过随机生成的方式初始化一定数量的个体构成GA的种群<br>种群的初始化和具体问题相关，一般来说可以采取某种分布（如高斯分布）在一定求解范围内随机获取</p>
<h2 id="种群评价"><a href="#种群评价" class="headerlink" title="种群评价"></a>种群评价</h2><p>种群的评价即计算种群中个体的适应度值。假设种群population有popsize个个体。依次计算每个个体的适应度值及评价种群。或者利用启发式算法对种群中的个体（矩形件的排入顺序）生成排样图并依此计算个体的适应函数值（利用率），然后保存当前种群中的最优个体作为搜索到的最优解。</p>
<h2 id="选择操作"><a href="#选择操作" class="headerlink" title="选择操作"></a>选择操作</h2><p>常见的选择操作有轮盘赌的方式：根据个体的适应度计算被选中的概率，公式如下：</p>
<p>$$P(x_j)=\frac{fit(x_j)}{\sum_{i=1}^n fit(x_i)}, j\in{1,2,…,n}$$</p>
<h2 id="交叉操作"><a href="#交叉操作" class="headerlink" title="交叉操作"></a>交叉操作</h2><p>一般以概率阀值Pc控制是否进行单点交叉、多点交叉或者其他交叉方式生成新的交叉个体。</p>
<p>交叉操作也有许多种：单点交叉，两点交叉等。此处仅讲解一下两点交叉。首先利用选择操作从种群中选择两个父辈个体parent1和parent2,然后随机产生两个位置pos1和pos2，将这两个位置中间的基因位信息进行交换，便得到下图所示的off1和off2两个个体，但是这两个个体中一般会存在基因位信息冲突的现象（整数编码时），此时需要对off1和off2个体进行调整：off1中的冲突基因根据parent1中的基因调整为parent2中的相同位置处的基因。如off1中的“1”出现了两次，则第二处的“1”需要调整为parent1中“1”对应的parent2中的“4”，依次类推处理off1中的相冲突的基因。需要注意的是，调整off2，则需要参考parent2。</p>
<p><img src="https://raw.githubusercontent.com/imonce/imgs/master/20191107151135.png"></p>
<h2 id="变异操作"><a href="#变异操作" class="headerlink" title="变异操作"></a>变异操作</h2><p>一般以概率阀值Pm控制是否对个体的部分基因执行单点变异或多点变异。</p>
<p>变异操作的话，根据不同的编码方式有不同的变异操作。</p>
<p>如果是浮点数编码，则变异可以就染色体中间的某一个基因位的信息进行变异（重新生成或者其他调整方案）。</p>
<p>如果是采用整数编码方案，则一般有多种变异方法：位置变异（调换同一个体的多个基因）和符号变异（正数变负数）。</p>
<h1 id="python实现"><a href="#python实现" class="headerlink" title="python实现"></a>python实现</h1><p>求 $f(x,y)=21.5+x\times\sin(4\times\pi\times x) + y \times\sin(20\times\pi\times y)$ 的最大值</p>
<p>代码来自：<br><a href="https://blog.csdn.net/qq_30666517/article/details/78637255" target="_blank" rel="noopener">https://blog.csdn.net/qq_30666517/article/details/78637255</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*- </span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.optimize <span class="keyword">import</span> fsolve, basinhopping</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 根据解的精度确定染色体(chromosome)的长度</span></span><br><span class="line"><span class="comment"># 需要根据决策变量的上下边界来确定</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getEncodedLength</span><span class="params">(delta=<span class="number">0.0001</span>, boundarylist=[])</span>:</span></span><br><span class="line">	<span class="comment"># 每个变量的编码长度</span></span><br><span class="line">	lengths = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> boundarylist:</span><br><span class="line">		lower = i[<span class="number">0</span>]</span><br><span class="line">		upper = i[<span class="number">1</span>]</span><br><span class="line">		<span class="comment"># lamnda 代表匿名函数f(x)=0,50代表搜索的初始解</span></span><br><span class="line">		res = fsolve(<span class="keyword">lambda</span> x: ((upper - lower) * <span class="number">1</span> / delta) - <span class="number">2</span> ** x - <span class="number">1</span>, <span class="number">50</span>)</span><br><span class="line">		length = int(np.floor(res[<span class="number">0</span>]))</span><br><span class="line">		lengths.append(length)</span><br><span class="line">	<span class="keyword">return</span> lengths</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 随机生成初始编码种群</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getIntialPopulation</span><span class="params">(encodelength, populationSize)</span>:</span></span><br><span class="line">	<span class="comment"># 随机化初始种群为0</span></span><br><span class="line">	chromosomes = np.zeros((populationSize, sum(encodelength)), dtype=np.uint8)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(populationSize):</span><br><span class="line">		chromosomes[i, :] = np.random.randint(<span class="number">0</span>, <span class="number">2</span>, sum(encodelength))</span><br><span class="line">	<span class="comment"># print('chromosomes shape:', chromosomes.shape)</span></span><br><span class="line">	<span class="keyword">return</span> chromosomes</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 染色体解码得到表现型的解</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decodedChromosome</span><span class="params">(encodelength, chromosomes, boundarylist, delta=<span class="number">0.0001</span>)</span>:</span></span><br><span class="line">	populations = chromosomes.shape[<span class="number">0</span>]</span><br><span class="line">	variables = len(encodelength)</span><br><span class="line">	decodedvalues = np.zeros((populations, variables))</span><br><span class="line">	<span class="keyword">for</span> k, chromosome <span class="keyword">in</span> enumerate(chromosomes):</span><br><span class="line">		chromosome = chromosome.tolist()</span><br><span class="line">		start = <span class="number">0</span></span><br><span class="line">		<span class="keyword">for</span> index, length <span class="keyword">in</span> enumerate(encodelength):</span><br><span class="line">			<span class="comment"># 将一个染色体进行拆分，得到染色体片段</span></span><br><span class="line">			power = length - <span class="number">1</span></span><br><span class="line">			<span class="comment"># 解码得到的10进制数字</span></span><br><span class="line">			demical = <span class="number">0</span></span><br><span class="line">			<span class="keyword">for</span> i <span class="keyword">in</span> range(start, length + start):</span><br><span class="line">				demical += chromosome[i] * (<span class="number">2</span> ** power)</span><br><span class="line">				power -= <span class="number">1</span></span><br><span class="line">			lower = boundarylist[index][<span class="number">0</span>]</span><br><span class="line">			upper = boundarylist[index][<span class="number">1</span>]</span><br><span class="line">			decodedvalue = lower + demical * (upper - lower) / (<span class="number">2</span> ** length - <span class="number">1</span>)</span><br><span class="line">			decodedvalues[k, index] = decodedvalue</span><br><span class="line">			<span class="comment"># 开始去下一段染色体的编码</span></span><br><span class="line">			start = length</span><br><span class="line">	<span class="keyword">return</span> decodedvalues</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 得到个体的适应度值及每个个体被选择的累积概率</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getFitnessValue</span><span class="params">(func, chromosomesdecoded)</span>:</span></span><br><span class="line">	<span class="comment"># 得到种群规模和决策变量的个数</span></span><br><span class="line">	population, nums = chromosomesdecoded.shape</span><br><span class="line">	<span class="comment"># 初始化种群的适应度值为0</span></span><br><span class="line">	fitnessvalues = np.zeros((population, <span class="number">1</span>))</span><br><span class="line">	<span class="comment"># 计算适应度值</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(population):</span><br><span class="line">		fitnessvalues[i, <span class="number">0</span>] = func(chromosomesdecoded[i, :])</span><br><span class="line">	<span class="comment"># 计算每个染色体被选择的概率</span></span><br><span class="line">	probability = fitnessvalues / np.sum(fitnessvalues)</span><br><span class="line">	<span class="comment"># 得到每个染色体被选中的累积概率</span></span><br><span class="line">	cum_probability = np.cumsum(probability)</span><br><span class="line">	<span class="keyword">return</span> fitnessvalues, cum_probability</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 新种群选择</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">selectNewPopulation</span><span class="params">(chromosomes, cum_probability)</span>:</span></span><br><span class="line">	m, n = chromosomes.shape</span><br><span class="line">	newpopulation = np.zeros((m, n), dtype=np.uint8)</span><br><span class="line">	<span class="comment"># 随机产生M个概率值</span></span><br><span class="line">	randoms = np.random.rand(m)</span><br><span class="line">	<span class="keyword">for</span> i, randoma <span class="keyword">in</span> enumerate(randoms):</span><br><span class="line">		logical = cum_probability &gt;= randoma</span><br><span class="line">		index = np.where(logical == <span class="number">1</span>)</span><br><span class="line">		<span class="comment"># index是tuple,tuple中元素是ndarray</span></span><br><span class="line">		newpopulation[i, :] = chromosomes[index[<span class="number">0</span>][<span class="number">0</span>], :]</span><br><span class="line">	<span class="keyword">return</span> newpopulation</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 新种群交叉</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crossover</span><span class="params">(population, Pc=<span class="number">0.8</span>)</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">	:param population: 新种群</span></span><br><span class="line"><span class="string">	:param Pc: 交叉概率默认是0.8</span></span><br><span class="line"><span class="string">	:return: 交叉后得到的新种群</span></span><br><span class="line"><span class="string">	"""</span></span><br><span class="line">	<span class="comment"># 根据交叉概率计算需要进行交叉的个体个数</span></span><br><span class="line">	m, n = population.shape</span><br><span class="line">	numbers = np.uint8(m * Pc)</span><br><span class="line">	<span class="comment"># 确保进行交叉的染色体个数是偶数个</span></span><br><span class="line">	<span class="keyword">if</span> numbers % <span class="number">2</span> != <span class="number">0</span>:</span><br><span class="line">		numbers += <span class="number">1</span></span><br><span class="line">	<span class="comment"># 交叉后得到的新种群</span></span><br><span class="line">	updatepopulation = np.zeros((m, n), dtype=np.uint8)</span><br><span class="line">	<span class="comment"># 产生随机索引</span></span><br><span class="line">	index = random.sample(range(m), numbers)</span><br><span class="line">	<span class="comment"># 不进行交叉的染色体进行复制</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(m):</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> index.__contains__(i):</span><br><span class="line">			updatepopulation[i, :] = population[i, :]</span><br><span class="line">	<span class="comment"># crossover</span></span><br><span class="line">	<span class="keyword">while</span> len(index) &gt; <span class="number">0</span>:</span><br><span class="line">		a = index.pop()</span><br><span class="line">		b = index.pop()</span><br><span class="line">		<span class="comment"># 随机产生一个交叉点</span></span><br><span class="line">		crossoverPoint = random.sample(range(<span class="number">1</span>, n), <span class="number">1</span>)</span><br><span class="line">		crossoverPoint = crossoverPoint[<span class="number">0</span>]</span><br><span class="line">		<span class="comment"># one-single-point crossover</span></span><br><span class="line">		updatepopulation[a, <span class="number">0</span>:crossoverPoint] = population[a, <span class="number">0</span>:crossoverPoint]</span><br><span class="line">		updatepopulation[a, crossoverPoint:] = population[b, crossoverPoint:]</span><br><span class="line">		updatepopulation[b, <span class="number">0</span>:crossoverPoint] = population[b, <span class="number">0</span>:crossoverPoint]</span><br><span class="line">		updatepopulation[b, crossoverPoint:] = population[a, crossoverPoint:]</span><br><span class="line">	<span class="keyword">return</span> updatepopulation</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 染色体变异</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mutation</span><span class="params">(population, Pm=<span class="number">0.01</span>)</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">	:param population: 经交叉后得到的种群</span></span><br><span class="line"><span class="string">	:param Pm: 变异概率默认是0.01</span></span><br><span class="line"><span class="string">	:return: 经变异操作后的新种群</span></span><br><span class="line"><span class="string">	"""</span></span><br><span class="line">	updatepopulation = np.copy(population)</span><br><span class="line">	m, n = population.shape</span><br><span class="line">	<span class="comment"># 计算需要变异的基因个数</span></span><br><span class="line">	gene_num = np.uint8(m * n * Pm)</span><br><span class="line">	<span class="comment"># 将所有的基因按照序号进行10进制编码，则共有m*n个基因</span></span><br><span class="line">	<span class="comment"># 随机抽取gene_num个基因进行基本位变异</span></span><br><span class="line">	mutationGeneIndex = random.sample(range(<span class="number">0</span>, m * n), gene_num)</span><br><span class="line">	<span class="comment"># 确定每个将要变异的基因在整个染色体中的基因座(即基因的具体位置)</span></span><br><span class="line">	<span class="keyword">for</span> gene <span class="keyword">in</span> mutationGeneIndex:</span><br><span class="line">		<span class="comment"># 确定变异基因位于第几个染色体</span></span><br><span class="line">		chromosomeIndex = gene // n</span><br><span class="line">		<span class="comment"># 确定变异基因位于当前染色体的第几个基因位</span></span><br><span class="line">		geneIndex = gene % n</span><br><span class="line">		<span class="comment"># mutation</span></span><br><span class="line">		<span class="keyword">if</span> updatepopulation[chromosomeIndex, geneIndex] == <span class="number">0</span>:</span><br><span class="line">			updatepopulation[chromosomeIndex, geneIndex] = <span class="number">1</span></span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			updatepopulation[chromosomeIndex, geneIndex] = <span class="number">0</span></span><br><span class="line">	<span class="keyword">return</span> updatepopulation</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 定义适应度函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fitnessFunction</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">lambda</span> x: <span class="number">21.5</span> + x[<span class="number">0</span>] * np.sin(<span class="number">4</span> * np.pi * x[<span class="number">0</span>]) + x[<span class="number">1</span>] * np.sin(<span class="number">20</span> * np.pi * x[<span class="number">1</span>])</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(max_iter=<span class="number">500</span>)</span>:</span></span><br><span class="line">    <span class="comment"># 每次迭代得到的最优解</span></span><br><span class="line">    optimalSolutions = []</span><br><span class="line">    optimalValues = []</span><br><span class="line">    <span class="comment"># 决策变量的取值范围</span></span><br><span class="line">    decisionVariables = [[<span class="number">-3.0</span>, <span class="number">12.1</span>], [<span class="number">4.1</span>, <span class="number">5.8</span>]]</span><br><span class="line">    <span class="comment"># 得到染色体编码长度</span></span><br><span class="line">    lengthEncode = getEncodedLength(boundarylist=decisionVariables)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 得到初始种群编码</span></span><br><span class="line">    chromosomesEncoded = getIntialPopulation(lengthEncode, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> iteration <span class="keyword">in</span> range(max_iter):</span><br><span class="line">        <span class="comment"># 种群解码</span></span><br><span class="line">        decoded = decodedChromosome(lengthEncode, chromosomesEncoded, decisionVariables)</span><br><span class="line">        <span class="comment"># 得到个体适应度值和个体的累积概率</span></span><br><span class="line">        evalvalues, cum_proba = getFitnessValue(fitnessFunction(), decoded)</span><br><span class="line">        <span class="comment"># 选择新的种群</span></span><br><span class="line">        newpopulations = selectNewPopulation(chromosomesEncoded, cum_proba)</span><br><span class="line">        <span class="comment"># 进行交叉操作</span></span><br><span class="line">        crossoverpopulation = crossover(newpopulations)</span><br><span class="line">        <span class="comment"># mutation</span></span><br><span class="line">        mutationpopulation = mutation(crossoverpopulation)</span><br><span class="line">        <span class="comment"># 将变异后的种群解码，得到每轮迭代最终的种群</span></span><br><span class="line">        final_decoded = decodedChromosome(lengthEncode, mutationpopulation, decisionVariables)</span><br><span class="line">        <span class="comment"># 适应度评价</span></span><br><span class="line">        fitnessvalues, cum_individual_proba = getFitnessValue(fitnessFunction(), final_decoded)</span><br><span class="line">        <span class="comment"># 搜索每次迭代的最优解，以及最优解对应的目标函数的取值</span></span><br><span class="line">        optimalValues.append(np.max(list(fitnessvalues)))</span><br><span class="line">        index = np.where(fitnessvalues == max(list(fitnessvalues)))</span><br><span class="line">        optimalSolutions.append(final_decoded[index[<span class="number">0</span>][<span class="number">0</span>], :])</span><br><span class="line">        chromosomesEncoded = mutationpopulation</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 搜索最优解</span></span><br><span class="line">    optimalValue = np.max(optimalValues)</span><br><span class="line">    optimalIndex = np.where(optimalValues == optimalValue)</span><br><span class="line">    optimalSolution = optimalSolutions[optimalIndex[<span class="number">0</span>][<span class="number">0</span>]]</span><br><span class="line">    <span class="keyword">return</span> optimalSolution, optimalValue</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">solution, value = main()</span><br><span class="line">print(<span class="string">'最优解: x1, x2'</span>)</span><br><span class="line">print(solution[<span class="number">0</span>], solution[<span class="number">1</span>])</span><br><span class="line">print(<span class="string">'最优目标函数值:'</span>, value)</span><br><span class="line"><span class="comment"># 测量运行时间</span></span><br><span class="line">elapsedtime = timeit.timeit(stmt=main, number=<span class="number">1</span>)</span><br><span class="line">print(<span class="string">'Searching Time Elapsed:(S)'</span>, elapsedtime)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Reference:<br><a href="https://blog.csdn.net/bible_reader/article/details/72782675" target="_blank" rel="noopener">https://blog.csdn.net/bible_reader/article/details/72782675</a><br><a href="https://blog.csdn.net/qq_30666517/article/details/78637255" target="_blank" rel="noopener">https://blog.csdn.net/qq_30666517/article/details/78637255</a><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: Start
op1=>operation: 种群初始化
op2=>operation: 评估种群
op3=>operation: 选择操作
op4=>operation: 直接将选中的个体作为临时个体
op5=>operation: 对选中的个体进行交叉操作，产生交叉个体
op6=>operation: 直接将所有临时个体放入下一代种群中
op7=>operation: 对临时个体进行变异操作，再投入到下一代种群中
op8=>operation: 输出最优结果
cond1=>condition: 是否进行交叉操作
cond2=>condition: 是否进行变异操作
cond3=>condition: 满足终止条件?
ed=>end: End
st->op1->op2->op3->cond1(no)->op4->cond2(no)->op6->cond3(yes)->op8->ed
cond1(yes)->op5->cond2
cond2(yes)->op7->cond3
cond3(no)->op2</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/11/06/SQL语句命令执行顺序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/06/SQL语句命令执行顺序/" class="post-title-link" itemprop="url">SQL语句命令执行顺序</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-06 22:42:22" itemprop="dateCreated datePublished" datetime="2019-11-06T22:42:22+08:00">2019-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-04 16:03:26" itemprop="dateModified" datetime="2020-01-04T16:03:26+08:00">2020-01-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/11/06/SQL语句命令执行顺序/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/06/SQL语句命令执行顺序/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <div id="flowchart-0" class="flow-chart"></div><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">op1=>operation: from + join
op2=>operation: where
op3=>operation: group by
op4=>operation: having
op5=>operation: select
op6=>operation: order by
op7=>operation: limit
op1->op2->op3->op4->op5->op6->op7</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script>
          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/11/06/启发式算法学习（二）：模拟退火算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/06/启发式算法学习（二）：模拟退火算法/" class="post-title-link" itemprop="url">启发式算法学习（二）：模拟退火算法SAA</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-06 20:11:32" itemprop="dateCreated datePublished" datetime="2019-11-06T20:11:32+08:00">2019-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-26 22:14:20" itemprop="dateModified" datetime="2022-12-26T22:14:20+08:00">2022-12-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/启发式算法/" itemprop="url" rel="index"><span itemprop="name">启发式算法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/11/06/启发式算法学习（二）：模拟退火算法/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/06/启发式算法学习（二）：模拟退火算法/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <h1 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h1><p>模拟退火算法（Simulated annealing algorithm，SAA）的思想借鉴于固体的退火原理，当固体的温度很高的时候，内能比较大，固体的内部粒子处于快速无序运动，当温度慢慢降低的过程中，固体的内能减小，粒子的慢慢趋于有序，最终，当固体处于常温时，内能达到最小，此时，粒子最为稳定。模拟退火算法便是基于这样的原理设计而成。</p>
<p>模拟退火算法从某一高温出发，在高温状态下计算初始解，然后以预设的邻域函数产生一个扰动量，从而得到新的状态，即模拟粒子的无序运动，比较新旧状态下的能量，即目标函数的解。如果新状态的能量小于旧状态，则状态发生转化；如果新状态的能量大于旧状态，则以一定的概率准则发生转化。当状态稳定后，便可以看作达到了当前状态的最优解，便可以开始降温，在下一个温度继续迭代，最终达到低温的稳定状态，便得到了模拟退火算法产生的结果。</p>
<h1 id="算法过程"><a href="#算法过程" class="headerlink" title="算法过程"></a>算法过程</h1><div id="flowchart-0" class="flow-chart"></div>

<h1 id="状态空间与邻域函数"><a href="#状态空间与邻域函数" class="headerlink" title="状态空间与邻域函数"></a>状态空间与邻域函数</h1><p>状态空间也称为搜索空间，它由经过编码的可行解的集合所组成。而邻域函数应尽可能满足产生的候选解遍布全部状态空间。其通常由产生候选解的方式和候选解产生的概率分布组成。候选解一般按照某一概率密度函数对解空间进行随机采样获得，而概率分布可以为均匀分布、正态分布、指数分布等。</p>
<h1 id="状态概率分布（Metropolis准则）"><a href="#状态概率分布（Metropolis准则）" class="headerlink" title="状态概率分布（Metropolis准则）"></a>状态概率分布（Metropolis准则）</h1><p>状态转移概率是指从一个状态转换成另一个状态的概率，模拟退火算法中一般采用Metropolis准则，具体如下：</p>
<p>$$f(x)=\left\lbrace\begin{array}{cll}<br>1 &amp; , &amp; E(x_{new}) &lt; E(x_{old}) \\<br>exp(-\frac{E(x_{new})-E(x_{old})}{T}) &amp; , &amp; E(x_{new}) \ge E(x_{old})<br>\end{array}\right.$$</p>
<p>其与当前温度参数T有关，随温度的下降而减小。</p>
<h1 id="冷却进度表"><a href="#冷却进度表" class="headerlink" title="冷却进度表"></a>冷却进度表</h1><p>冷却进度表是指从某一高温状态T向低温状态冷却时的降温函数,设时刻的温度为T(t)，则经典模拟退火算法的降温方式为：</p>
<p>$$T(t)=\frac{T_{0}}{lg(1+t)}$$</p>
<p>而快速模拟退火算法的降温方式为：</p>
<p>$$T(t)=\frac{T_{0}}{1+t}$$</p>
<p>其他方法不再赘述。</p>
<h1 id="初始温度"><a href="#初始温度" class="headerlink" title="初始温度"></a>初始温度</h1><p>一般来说，初始温度越大，获得高质量解的几率越大，但是花费的时间也会随之增加，因此，初温的确定应该同时考虑计算效率与优化质量，常用的方法包括：</p>
<p>1.均匀抽样一组状态，以各状态目标值的方差为初温。</p>
<p>2.随机产生一组状态，确定两两状态间的最大目标值差，然后根据差值，利用一定的函数确定初温，如： $T_{0}=-\frac{\Delta_{max}}{Pr}$ ,其中Pr为初始接受概率。</p>
<p>3.根据经验公式给出。</p>
<h1 id="循环终止准则"><a href="#循环终止准则" class="headerlink" title="循环终止准则"></a>循环终止准则</h1><p>内循环（求解循环）终止准则：</p>
<ol>
<li>检验目标函数的均值是否稳定</li>
<li>连续若干步的目标值变化较小</li>
<li>按一定的步数进行抽样</li>
</ol>
<p>外循环（降温循环）终止准则：</p>
<ol>
<li>设置终止温度</li>
<li>设置外循环迭代次数</li>
<li>算法搜索到的最优值连续若干步保持不变</li>
<li>检验系统熵是否稳定</li>
</ol>
<h1 id="Python实现"><a href="#Python实现" class="headerlink" title="Python实现"></a>Python实现</h1><p>实例函数： $f(x)=(x^{2}-5x)sin(x^2)$ </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SA</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, interval, tab=<span class="string">'min'</span>, T_max=<span class="number">10000</span>, T_min=<span class="number">1</span>, iterMax=<span class="number">1000</span>, rate=<span class="number">0.95</span>)</span>:</span></span><br><span class="line">        self.interval = interval <span class="comment"># 给定状态空间 - 即待求解空间</span></span><br><span class="line">        self.T_max = T_max <span class="comment"># 初始退火温度 - 温度上限</span></span><br><span class="line">        self.T_min = T_min <span class="comment"># 截止退火温度 - 温度下限</span></span><br><span class="line">        self.iterMax = iterMax <span class="comment"># 定温内部迭代次数</span></span><br><span class="line">        self.rate = rate <span class="comment"># 退火降温速度</span></span><br><span class="line">        </span><br><span class="line">        self.x_seed = random.uniform(interval[<span class="number">0</span>], interval[<span class="number">1</span>]) <span class="comment"># 解空间内的种子</span></span><br><span class="line">        self.tab = tab.strip() <span class="comment"># 求解最大值还是最小值的标签: 'min' - 最小值；'max' - 最大值</span></span><br><span class="line"></span><br><span class="line">        self.solve() <span class="comment"># 完成主体的求解过程</span></span><br><span class="line">        self.display() <span class="comment"># 数据可视化展示</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">solve</span><span class="params">(self)</span>:</span></span><br><span class="line">        temp = <span class="string">'deal_'</span> + self.tab <span class="comment"># 采用反射方法提取对应的函数</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(self, temp):</span><br><span class="line">            deal = getattr(self, temp)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            exit(<span class="string">'&gt;&gt;&gt;tab标签传参有误："min"|"max"&lt;&lt;&lt;'</span>)  </span><br><span class="line">        x1 = self.x_seed</span><br><span class="line">        T = self.T_max</span><br><span class="line">        <span class="keyword">while</span> T &gt;= self.T_min:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(self.iterMax):</span><br><span class="line">                f1 = self.func(x1)</span><br><span class="line">                delta_x = random.random() * <span class="number">2</span> - <span class="number">1</span> <span class="comment"># [-1,1)之间的随机值</span></span><br><span class="line">                <span class="keyword">if</span> x1 + delta_x &gt;= self.interval[<span class="number">0</span>] <span class="keyword">and</span> x1 + delta_x &lt;= self.interval[<span class="number">1</span>]:   <span class="comment"># 将随机解束缚在给定状态空间内</span></span><br><span class="line">                    x2 = x1 + delta_x</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    x2 = x1 - delta_x</span><br><span class="line">                f2 = self.func(x2)</span><br><span class="line">                delta_f = f2 - f1</span><br><span class="line">                x1 = deal(x1, x2, delta_f, T)</span><br><span class="line">            T *= self.rate</span><br><span class="line">        self.x_solu = x1 <span class="comment"># 提取最终退火解       </span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self, x)</span>:</span> <span class="comment"># 状态产生函数 - 即待求解函数</span></span><br><span class="line">        value = np.sin(x**<span class="number">2</span>) * (x**<span class="number">2</span> - <span class="number">5</span>*x)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">p_min</span><span class="params">(self, delta, T)</span>:</span> <span class="comment"># 计算最小值时，容忍解的状态迁移概率</span></span><br><span class="line">        probability = np.exp(-delta/T)</span><br><span class="line">        <span class="keyword">return</span> probability</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">p_max</span><span class="params">(self, delta, T)</span>:</span></span><br><span class="line">        probability = np.exp(delta/T) <span class="comment"># 计算最大值时，容忍解的状态迁移概率</span></span><br><span class="line">        <span class="keyword">return</span> probability</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deal_min</span><span class="params">(self, x1, x2, delta, T)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> delta &lt; <span class="number">0</span>: <span class="comment"># 更优解</span></span><br><span class="line">            <span class="keyword">return</span> x2</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># 容忍解</span></span><br><span class="line">            P = self.p_min(delta, T)</span><br><span class="line">            <span class="keyword">if</span> P &gt; random.random(): <span class="keyword">return</span> x2</span><br><span class="line">            <span class="keyword">else</span>: <span class="keyword">return</span> x1</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deal_max</span><span class="params">(self, x1, x2, delta, T)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> delta &gt; <span class="number">0</span>: <span class="comment"># 更优解</span></span><br><span class="line">            <span class="keyword">return</span> x2</span><br><span class="line">        <span class="keyword">else</span>: <span class="comment"># 容忍解</span></span><br><span class="line">            P = self.p_max(delta, T)</span><br><span class="line">            <span class="keyword">if</span> P &gt; random.random(): <span class="keyword">return</span> x2</span><br><span class="line">            <span class="keyword">else</span>: <span class="keyword">return</span> x1</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">display</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'seed: &#123;&#125;\nsolution: &#123;&#125;'</span>.format(self.x_seed, self.x_solu))</span><br><span class="line">        plt.figure(figsize=(<span class="number">6</span>, <span class="number">4</span>))</span><br><span class="line">        x = np.linspace(self.interval[<span class="number">0</span>], self.interval[<span class="number">1</span>], <span class="number">300</span>)</span><br><span class="line">        y = self.func(x)</span><br><span class="line">        plt.plot(x, y, <span class="string">'g-'</span>, label=<span class="string">'function'</span>)</span><br><span class="line">        plt.plot(self.x_seed, self.func(self.x_seed), <span class="string">'bo'</span>, label=<span class="string">'seed'</span>)</span><br><span class="line">        plt.plot(self.x_solu, self.func(self.x_solu), <span class="string">'r*'</span>, label=<span class="string">'solution'</span>)</span><br><span class="line">        plt.title(<span class="string">'solution = &#123;&#125;'</span>.format(self.x_solu))</span><br><span class="line">        plt.xlabel(<span class="string">'x'</span>)</span><br><span class="line">        plt.ylabel(<span class="string">'y'</span>)</span><br><span class="line">        plt.legend()</span><br><span class="line">        plt.savefig(<span class="string">'SA.png'</span>, dpi=<span class="number">500</span>)</span><br><span class="line">        plt.show()</span><br><span class="line">        plt.close()</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    SA([<span class="number">-5</span>, <span class="number">5</span>], <span class="string">'max'</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Reference<br><a href="https://www.imooc.com/article/30160" target="_blank" rel="noopener">https://www.imooc.com/article/30160</a><br><a href="https://baike.baidu.com/item/%E6%A8%A1%E6%8B%9F%E9%80%80%E7%81%AB%E7%AE%97%E6%B3%95/355508?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/模拟退火算法/355508?fr=aladdin</a><br><a href="https://blog.csdn.net/google19890102/article/details/45395257" target="_blank" rel="noopener">https://blog.csdn.net/google19890102/article/details/45395257</a><br><a href="https://www.cnblogs.com/xxhbdk/p/9192750.html" target="_blank" rel="noopener">https://www.cnblogs.com/xxhbdk/p/9192750.html</a><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: Start
op1=>operation: 随机生成初始解w，计算目标函数f(w)
op2=>operation: 扰动产生新解w'，计算目标函数f(w')
op3=>operation: 接受新解，w=w'，f(w)=f(w')
op4=>operation: 按照Metropolis准则接受新解
op5=>operation: 缓慢降低温度，重置迭代次数
op6=>operation: 运算结束，返回最优解
cond1=>condition: f(w')更接近优化目标？
cond2=>condition: 是否达到迭代次数?
cond3=>condition: 满足终止条件?
ed=>end: End
st->op1->op2->cond1(yes)->op3->cond2(no)->cond3(yes)->op6->ed
cond1(no)->op4->cond2
cond2(yes)->op6->ed
cond3(no)->op5(top)->op2</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/11/06/启发式算法学习（一）：粒子群算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/06/启发式算法学习（一）：粒子群算法/" class="post-title-link" itemprop="url">启发式算法学习（一）：粒子群算法PSO</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-06 16:47:13" itemprop="dateCreated datePublished" datetime="2019-11-06T16:47:13+08:00">2019-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-04 16:08:04" itemprop="dateModified" datetime="2020-01-04T16:08:04+08:00">2020-01-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/启发式算法/" itemprop="url" rel="index"><span itemprop="name">启发式算法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/11/06/启发式算法学习（一）：粒子群算法/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/06/启发式算法学习（一）：粒子群算法/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <h1 id="算法简介"><a href="#算法简介" class="headerlink" title="算法简介"></a>算法简介</h1><p>粒子群算法（Particle swarm optimization，PSO）是模拟群体智能所建立起来的一种优化算法，主要用于解决最优化问题（optimization problems）。1995年由 Eberhart和Kennedy 提出，是基于对鸟群觅食行为的研究和模拟而来的。</p>
<p>假设一群鸟在觅食，在觅食范围内，只在一个地方有食物，所有鸟儿都看不到食物（即不知道食物的具体位置。当然不知道了，知道了就不用觅食了），但是能闻到食物的味道（即能知道食物距离自己是远是近。鸟的嗅觉是很灵敏的）。</p>
<p>假设鸟与鸟之间能共享信息（即互相知道每个鸟离食物多远。这个是人工假定，实际上鸟们肯定不会也不愿意），那么最好的策略就是结合自己离食物最近的位置和鸟群中其他鸟距离食物最近的位置这2个因素综合考虑找到最好的搜索位置。</p>
<p>粒子群算法与《遗传算法》等进化算法有很多相似之处。也需要初始化种群，计算适应度值，通过进化进行迭代等。但是与遗传算法不同，它没有交叉，变异等进化操作。与遗传算法比较，PSO的优势在于很容易编码，需要调整的参数也很少。</p>
<h1 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h1><p>PSO有几个核心概念：</p>
<ol>
<li>粒子（particle）：一只鸟。类似于遗传算法中的个体。</li>
<li>种群（population）：一群鸟。类似于遗传算法中的种群。</li>
<li>位置（position）：一个粒子（鸟）当前所在的位置。</li>
<li>经验（best）：一个粒子（鸟）自身曾经离食物最近的位置。</li>
<li>速度（velocity ）：一个粒子（鸟）飞行的速度。</li>
<li>适应度（fitness）：一个粒子（鸟）距离食物的远近。与遗传算法中的适应度类似。</li>
</ol>
<h1 id="算法过程"><a href="#算法过程" class="headerlink" title="算法过程"></a>算法过程</h1><div id="flowchart-0" class="flow-chart"></div>

<h1 id="算法说明"><a href="#算法说明" class="headerlink" title="算法说明"></a>算法说明</h1><h2 id="两个核心公式"><a href="#两个核心公式" class="headerlink" title="两个核心公式"></a>两个核心公式</h2><p>加速度更新公式：</p>
<p>$$v[i] = w * v[i] + c1 * rand() *(pbest[i] - present[i]) + c2 * rand() * (gbest - present[i])$$</p>
<p>其中v[i]代表第i个粒子的速度，w代表惯性权值,c1和c2表示学习参数，rand()表示在0-1之间的随机数,pbest[i]代表第i个粒子搜索到的最优值,gbest代表整个集群搜索到的最优值,present[i]代表第i个粒子的当前位置。</p>
<p>位置更新公式：</p>
<p>$$present[i]=present[i]+v[i]$$</p>
<h2 id="解释说明"><a href="#解释说明" class="headerlink" title="解释说明"></a>解释说明</h2><p>1.粒子数：粒子数的选取一般在20个到40个之间，但是需要具体问题具体对待，如果对于复杂问题，则需要设置更多的粒子，粒子数量越多，其搜索范围就越大。</p>
<p>2.惯性因子 $w$ ：用来控制继承多少粒子当前的速度的，越大则对于当前速度的继承程度越小，越小则对于当前速度的继承程度越大。有些同学可能会产生疑问，是不是说反了。其实不是，从公式中可以明确看出，其值越大，则速度的改变幅度就越大，则对于粒子的当前速度继承越小；反之，速度的改变幅度越小，则对于粒子当前速度继承越大。因此如果的值越大，则解的搜索范围越大，可以提高算法的全局搜索能力，但也损失了局部搜索能力，有可能错失最优解；反之如果的值越小，则解的搜索范围也就越小，算法的全局搜索能力也就越小，容易陷入局部最优。如果是变量，则其值应该随着迭代次数的增加而减小（类似于梯度下降当中的学习率）。如果为定值，则建议在0.6到0.75之间进行选取。</p>
<p>3.加速常数 $c1,c2$ ：通过公式一可以看出，加速常数控制着飞翔速度的计算是更加看重自身经验还是群体经验。公式一中的第二项就是自身经验的体现，加速常数可以看做是用来调整自身经验在计算粒子飞翔速度上的权重。同理是用来控制群体经验在计算粒子飞翔速度过程中的权重的。如果为0，则自身经验对于速度的计算不起作用，如果为0，则群体经验对于粒子飞翔速度的计算不起作用。的取值在学术界分歧很大主要有如下几种情况：</p>
<table>
<thead>
<tr>
<th align="left">学者</th>
<th align="left">参数取值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Clerc</td>
<td align="left">c1=c2=2.05</td>
</tr>
<tr>
<td align="left">Carlisle</td>
<td align="left">c1=2.8, c2=1.3</td>
</tr>
<tr>
<td align="left">Trelea</td>
<td align="left">w=0.6, c1=c2=1.7</td>
</tr>
<tr>
<td align="left">Eberhart</td>
<td align="left">w=0.729, c1=c2=1.494</td>
</tr>
</tbody></table>
<h1 id="python实现"><a href="#python实现" class="headerlink" title="python实现"></a>python实现</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">f(x1,x2) = x1**2 + x2**2, x1,x2 belongs to [-10,10],求Min f</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSO</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, population_size, max_steps)</span>:</span></span><br><span class="line">        self.w = <span class="number">0.6</span>  <span class="comment"># 惯性权重</span></span><br><span class="line">        self.c1 = self.c2 = <span class="number">2</span></span><br><span class="line">        self.population_size = population_size  <span class="comment"># 粒子群数量</span></span><br><span class="line">        self.dim = <span class="number">2</span>  <span class="comment"># 搜索空间的维度</span></span><br><span class="line">        self.max_steps = max_steps  <span class="comment"># 迭代次数</span></span><br><span class="line">        self.x_bound = [<span class="number">-10</span>, <span class="number">10</span>]  <span class="comment"># 解空间范围</span></span><br><span class="line">        self.x = np.random.uniform(self.x_bound[<span class="number">0</span>], self.x_bound[<span class="number">1</span>],</span><br><span class="line">                                   (self.population_size, self.dim))  <span class="comment"># 初始化粒子群位置</span></span><br><span class="line">        self.v = np.random.rand(self.population_size, self.dim)  <span class="comment"># 初始化粒子群速度</span></span><br><span class="line">        fitness = self.calculate_fitness(self.x)</span><br><span class="line">        self.p = self.x  <span class="comment"># 个体的最佳位置</span></span><br><span class="line">        self.pg = self.x[np.argmin(fitness)]  <span class="comment"># 全局最佳位置</span></span><br><span class="line">        self.individual_best_fitness = fitness  <span class="comment"># 个体的最优适应度</span></span><br><span class="line">        self.global_best_fitness = np.max(fitness)  <span class="comment"># 全局最佳适应度</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calculate_fitness</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> np.sum(np.square(x), axis=<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">evolve</span><span class="params">(self)</span>:</span></span><br><span class="line">        fig = plt.figure()</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> range(self.max_steps):</span><br><span class="line">            r1 = np.random.rand(self.population_size, self.dim)</span><br><span class="line">            r2 = np.random.rand(self.population_size, self.dim)</span><br><span class="line">            <span class="comment"># 更新速度和权重</span></span><br><span class="line">            self.v = self.w*self.v+self.c1*r1*(self.p-self.x)+self.c2*r2*(self.pg-self.x)</span><br><span class="line">            self.x = self.v + self.x</span><br><span class="line">            plt.clf()</span><br><span class="line">            plt.scatter(self.x[:, <span class="number">0</span>], self.x[:, <span class="number">1</span>], s=<span class="number">30</span>, color=<span class="string">'k'</span>)</span><br><span class="line">            plt.xlim(self.x_bound[<span class="number">0</span>], self.x_bound[<span class="number">1</span>])</span><br><span class="line">            plt.ylim(self.x_bound[<span class="number">0</span>], self.x_bound[<span class="number">1</span>])</span><br><span class="line">            plt.pause(<span class="number">0.01</span>)</span><br><span class="line">            <span class="comment"># plt.ion()</span></span><br><span class="line">            <span class="comment"># plt.show()</span></span><br><span class="line">           </span><br><span class="line">            fitness = self.calculate_fitness(self.x)</span><br><span class="line">            <span class="comment"># 需要更新的个体</span></span><br><span class="line">            update_id = np.greater(self.individual_best_fitness, fitness)</span><br><span class="line">            self.p[update_id] = self.x[update_id]</span><br><span class="line">            self.individual_best_fitness[update_id] = fitness[update_id]</span><br><span class="line">            <span class="comment"># 新一代出现了更小的fitness，所以更新全局最优fitness和位置</span></span><br><span class="line">            <span class="keyword">if</span> np.min(fitness) &lt; self.global_best_fitness:</span><br><span class="line">                self.pg = self.x[np.argmin(fitness)]</span><br><span class="line">                self.global_best_fitness = np.min(fitness)</span><br><span class="line">            print(<span class="string">'best fitness: %.5f, mean fitness: %.5f'</span> % (self.global_best_fitness, np.mean(fitness)))</span><br><span class="line">            </span><br><span class="line">pso = PSO(<span class="number">10</span>, <span class="number">100</span>)</span><br><span class="line">pso.evolve()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Reference:<br><a href="https://blog.csdn.net/zhaozx19950803/article/details/79854466" target="_blank" rel="noopener">https://blog.csdn.net/zhaozx19950803/article/details/79854466</a><br><a href="https://blog.csdn.net/yy2050645/article/details/80740641" target="_blank" rel="noopener">https://blog.csdn.net/yy2050645/article/details/80740641</a><br><a href="https://blog.csdn.net/zj15527620802/article/details/81366105" target="_blank" rel="noopener">https://blog.csdn.net/zj15527620802/article/details/81366105</a><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: Start
op1=>operation: 初始化参数
op2=>operation: 计算各粒子适应值
op3=>operation: 找出个体和群体的最优值和最优位置
op4=>operation: 更新各个粒子的位置和速度
cond=>condition: 是否满足终止条件?
e=>end
st->op1->op2->op3->op4->cond
cond(yes)->e
cond(no)->op2</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/11/04/常见QoS指标一览/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/04/常见QoS指标一览/" class="post-title-link" itemprop="url">常见QoS指标一览</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-04 16:22:15" itemprop="dateCreated datePublished" datetime="2019-11-04T16:22:15+08:00">2019-11-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-12 17:33:44" itemprop="dateModified" datetime="2019-11-12T17:33:44+08:00">2019-11-12</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/11/04/常见QoS指标一览/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/11/04/常见QoS指标一览/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <p>英文： Quality of Service<br>中文： 服务质量<br>介绍： 指一个网络能够利用各种基础技术，为指定的网络通信提供更好的服务能力，是网络的一种安全机制，<strong>是用来解决网络延迟和阻塞等问题的一种技术</strong>。 通过配置QoS，对企业的网络流量进行调控，避免并管理网络拥塞，减少报文的丢失率，同时也可以为企业用户提供专用带宽或者为不同的业务（语音、视频、数据等）提供差分服务。</p>
<p>在正常情况下，如果网络只用于特定的无时间限制的应用系统，并不需要QoS，比如Web应用，或E-mail设置等。但是对关键应用和多媒体应用就十分必要。当网络过载或拥塞时，==QoS能确保重要业务量不受延迟或丢弃==，同时保证网络的高效运行。在RFC 3644上有对QoS的说明。</p>
<h1 id="可用性-Usability"><a href="#可用性-Usability" class="headerlink" title="可用性(Usability)"></a>可用性(Usability)</h1><p>是当用户需要时网络即能工作的时间百分比。可用性主要是设备可靠性和网络存活性相结合的结果。对它起作用的还有一些其他因素，包括软件稳定性以及网络演进或升级时不中断服务的能力。 在连续5min内，如果一个IP网络所提供的丢包率&lt;=75%，则认为该时间段是可用的，否则是不可用的。</p>
<h1 id="吞吐量-网络带宽-Throughput"><a href="#吞吐量-网络带宽-Throughput" class="headerlink" title="吞吐量(网络带宽)(Throughput)"></a>吞吐量(网络带宽)(Throughput)</h1><p>网络带宽是指在单位时间（一般指的是1秒钟）内能传输的数据量。对IP网而言可以从帧中继网借用一些概念。根据应用和服务类型，服务水平协议(SLA)可以规定承诺信息速率(CIR)、突发信息速率(BIR)和最大突发信号长度。承诺信息速率是应该予以严格保证的，对突发信息速率可以有所限定，以在容纳预定长度突发信号的同时容纳从话音到视像以及一般数据的各种服务。一般讲，吞吐量越大越好。</p>
<h1 id="时延-Latency-Packet-delay"><a href="#时延-Latency-Packet-delay" class="headerlink" title="时延(Latency)(Packet delay)"></a>时延(Latency)(Packet delay)</h1><p>指一项服务从网络入口到出口的平均经过时间。许多服务，特别是话音和视像等实时服务都是高度不能容忍时延的。当时延超过200-250毫秒时，交互式会话是非常麻烦的。为了提供高质量话音和会议电视，网络设备必须能保证低的时延。<br>产生时延的因素很多，包括分组时延、排队时延、交换时延和传播时延。传播时延是信息通过铜线、光纤或无线链路所需的时间，它是光速的函数。在任何系统中，包括同步数字系列(SDH)、异步传输模式（ATM）和弹性分组环路(RPR)，传播时延总是存在的。</p>
<h1 id="时延变化-抖动-Packet-delay-variation"><a href="#时延变化-抖动-Packet-delay-variation" class="headerlink" title="时延变化(抖动)(Packet delay variation)"></a>时延变化(抖动)(Packet delay variation)</h1><p>是指同一业务流中不同分组所呈现的时延不同。高频率的时延变化称作抖动，而低频率的时延变化称作漂移。抖动主要是由于业务流中相继分组的排队等候时间不同引起的，是对服务质量影响最大的一个问题。</p>
<p>​某些业务类型（特别是语音和视频等实时业务）是极其不能容忍抖动的。报文到达时间的差异将在语音或视频中造成断续；另外，抖动也会影响一些网络协议的处理，有些协议是按固定的时间间隔发送交互性报文，抖动过大就会导致协议震荡，而实际上所有传输系统都有抖动，但只要抖动在规定容差之内就不会影响服务质量，另外，可利用缓存来克服过量的抖动，但这将会增加时延。</p>
<p>漂移是任何同步传输系统都有的一个问题。在SDH系统中是通过严格的全网分级定时来克服漂移的。在异步系统中，漂移一般不是问题。漂移会造成基群失帧，使服务质量的要求不能满足。</p>
<h1 id="丢包-Packet-loss"><a href="#丢包-Packet-loss" class="headerlink" title="丢包(Packet loss)"></a>丢包(Packet loss)</h1><p>不管是比特丢失还是分组丢失，对分组数据业务的影响比对实时业务的影响都大。在通话期间，丢失一个比特或一个分组的信息往往用户注意不到。在视像广播期间，这在屏幕上可能造成瞬间的波形干扰，然后视像很快恢复如初。即便是用传输控制协议(TCP)传送数据也能处理丢失，因为传输控制协议允许丢失的信息重发。事实上，一种叫做随机早丢(RED)的拥塞控制机制在故意丢失分组，其目的是在流量达到设定门限时抑制TCP传输速率，减少拥塞，同时还使TCP流失去同步，以防止因速率窗口的闭合引起吞吐量摆动。但分组丢失多了，会影响传输质量。所以，要保持统计数字，当超过预定门限时就向网络管理人员告警。</p>
<p>丢包（packetloss）可能在所有环节中发生，例如：</p>
<ul>
<li>处理过程：路由器在收到报文的时候可能由于CPU繁忙，无法处理报文而导致丢包；</li>
<li>排队过程：在把报文调度到队列的时候可能由于队列被装满而导致丢包；</li>
<li>传输过程：报文在链路上传输的过程中，可能由于种种原因（如链路故障等）导致的丢包。</li>
</ul>
<blockquote>
<p>References:<br><a href="https://blog.csdn.net/qq_25077833/article/details/53428655" target="_blank" rel="noopener">https://blog.csdn.net/qq_25077833/article/details/53428655</a><br><a href="https://blog.csdn.net/kakingka/article/details/45698709" target="_blank" rel="noopener">https://blog.csdn.net/kakingka/article/details/45698709</a><br><a href="https://blog.csdn.net/qq_38265137/article/details/80466737" target="_blank" rel="noopener">https://blog.csdn.net/qq_38265137/article/details/80466737</a></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/10/21/3小时精通lxml-etree-Python中xml的读取、解析、生成和查找/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/21/3小时精通lxml-etree-Python中xml的读取、解析、生成和查找/" class="post-title-link" itemprop="url">3小时精通lxml.etree:Python中xml的读取、解析、生成和查找</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-21 17:04:41" itemprop="dateCreated datePublished" datetime="2019-10-21T17:04:41+08:00">2019-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-04 16:07:17" itemprop="dateModified" datetime="2020-01-04T16:07:17+08:00">2020-01-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learn-X-in-Y-minutes/" itemprop="url" rel="index"><span itemprop="name">Learn X in Y minutes</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Learn-X-in-Y-minutes/Learn-lxml-etree-in-Y-minutes/" itemprop="url" rel="index"><span itemprop="name">Learn lxml.etree in Y minutes</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/10/21/3小时精通lxml-etree-Python中xml的读取、解析、生成和查找/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/10/21/3小时精通lxml-etree-Python中xml的读取、解析、生成和查找/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <p>本文主要参考官方文档<a href="https://lxml.de/tutorial.html" target="_blank" rel="noopener">https://lxml.de/tutorial.html</a>整理，如有错误欢迎指出。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加Element默认添加为根节点</span></span><br><span class="line">root = etree.Element(<span class="string">"root"</span>)</span><br><span class="line"><span class="comment"># 通过append添加子节点</span></span><br><span class="line">root.append(etree.Element(<span class="string">"child1"</span>))</span><br><span class="line"><span class="comment"># 通过SubElement添加子节点</span></span><br><span class="line">child2 = etree.SubElement(root, <span class="string">"child2"</span>)</span><br><span class="line">child3 = etree.SubElement(root, <span class="string">"child3"</span>)</span><br><span class="line">print(etree.tostring(root))</span><br><span class="line">print(etree.tostring(root, pretty_print=<span class="keyword">True</span>))</span><br><span class="line"><span class="comment"># 默认encoding是ASCII</span></span><br><span class="line">print(etree.tostring(root, encoding=<span class="string">'iso-8859-1'</span>))</span><br><span class="line"><span class="comment"># 如果要把byte转成str输出的话，可以用下边的语句</span></span><br><span class="line">print(str(etree.tostring(root, pretty_print=<span class="keyword">True</span>),encoding=<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;&lt;child1/&gt;&lt;child2/&gt;&lt;child3/&gt;&lt;/root&gt;&#39;
b&#39;&lt;root&gt;\n  &lt;child1/&gt;\n  &lt;child2/&gt;\n  &lt;child3/&gt;\n&lt;/root&gt;\n&#39;
b&quot;&lt;?xml version=&#39;1.0&#39; encoding=&#39;iso-8859-1&#39;?&gt;\n&lt;root&gt;&lt;child1/&gt;&lt;child2/&gt;&lt;child3/&gt;&lt;/root&gt;&quot;
&lt;root&gt;
  &lt;child1/&gt;
  &lt;child2/&gt;
  &lt;child3/&gt;
&lt;/root&gt;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每个元素都是一个list</span></span><br><span class="line">child1 = root[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># .tag 可以取出元素的标签</span></span><br><span class="line">print(child1.tag, len(root))</span><br><span class="line"><span class="comment"># 大部分list方法都可以使用在element上</span></span><br><span class="line">root.insert(<span class="number">0</span>, etree.Element(<span class="string">"child0"</span>))</span><br><span class="line">print(root[<span class="number">0</span>].tag)</span><br></pre></td></tr></table></figure>

<pre><code>child1 3
child0</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以用list函数取出子元素的list</span></span><br><span class="line">children = list(root)</span><br><span class="line">print(root)</span><br><span class="line">print(children)</span><br></pre></td></tr></table></figure>

<pre><code>&lt;Element root at 0x107b03888&gt;
[&lt;Element child0 at 0x107b034c8&gt;, &lt;Element child1 at 0x107b03448&gt;, &lt;Element child2 at 0x107b038c8&gt;, &lt;Element child3 at 0x107b03908&gt;]</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过长度检查element是否为叶子节点</span></span><br><span class="line"><span class="keyword">if</span> len(root):</span><br><span class="line">    print(<span class="string">'root has children'</span>)</span><br><span class="line"><span class="keyword">if</span> len(child1):</span><br><span class="line">    print(<span class="string">'child1 has children'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'child1 has no child'</span>)</span><br></pre></td></tr></table></figure>

<pre><code>root has children
child1 has no child</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不同于普通list，赋值可能会造成元素移动</span></span><br><span class="line">print(etree.tostring(root))</span><br><span class="line">root[<span class="number">0</span>] = root[<span class="number">-1</span>]</span><br><span class="line">print(etree.tostring(root))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这是普通list</span></span><br><span class="line">l = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">print(l)</span><br><span class="line">l[<span class="number">0</span>] = l[<span class="number">-1</span>]</span><br><span class="line">print(l)</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;&lt;child0/&gt;&lt;child1/&gt;&lt;child2/&gt;&lt;child3/&gt;&lt;/root&gt;&#39;
b&#39;&lt;root&gt;&lt;child3/&gt;&lt;child1/&gt;&lt;child2/&gt;&lt;/root&gt;&#39;
[0, 1, 2, 3]
[3, 1, 2, 3]</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 要拷贝节点，需要调用deepcopy</span></span><br><span class="line">newroot = etree.Element(<span class="string">'newroot'</span>)</span><br><span class="line">newroot.append(deepcopy(root[<span class="number">1</span>]))</span><br><span class="line">print(etree.tostring(root))</span><br><span class="line">print(etree.tostring(newroot))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;&lt;child3/&gt;&lt;child1/&gt;&lt;child2/&gt;&lt;/root&gt;&#39;
b&#39;&lt;newroot&gt;&lt;child1/&gt;&lt;/newroot&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># etree元素自带方法可以找到对应的父节点、前一个节点、后一个节点</span></span><br><span class="line">print(root <span class="keyword">is</span> child1.getparent())</span><br><span class="line">print(root[<span class="number">0</span>] <span class="keyword">is</span> root[<span class="number">1</span>].getprevious())</span><br><span class="line">print(root[<span class="number">1</span>] <span class="keyword">is</span> root[<span class="number">0</span>].getnext())</span><br></pre></td></tr></table></figure>

<pre><code>True
True
True</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 属性以字典方式存储</span></span><br><span class="line">root = etree.Element(<span class="string">"root"</span>, interesting=<span class="string">"totally"</span>)</span><br><span class="line">print(etree.tostring(root))</span><br><span class="line"><span class="comment"># 通过get方法获取属性值</span></span><br><span class="line">print(root.get(<span class="string">"interesting"</span>))</span><br><span class="line">print(root.get(<span class="string">"hello"</span>))</span><br><span class="line"><span class="comment"># 通过set方法添加属性</span></span><br><span class="line">root.set(<span class="string">"hello"</span>, <span class="string">"Huhu"</span>)</span><br><span class="line">print(etree.tostring(root))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root interesting=&quot;totally&quot;/&gt;&#39;
totally
None
b&#39;&lt;root interesting=&quot;totally&quot; hello=&quot;Huhu&quot;/&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 字典的相关方法也可以直接使用</span></span><br><span class="line">print(root.items(), root.keys(), root.values())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 attrib 可以直接取出属性进行操作</span></span><br><span class="line">attributes = root.attrib</span><br><span class="line">print(attributes.get(<span class="string">"no-such-attribute"</span>))</span><br><span class="line"><span class="keyword">None</span></span><br><span class="line">attributes[<span class="string">"hello"</span>] = <span class="string">"Guten Tag"</span></span><br><span class="line">print(attributes[<span class="string">"hello"</span>])</span><br><span class="line"><span class="comment"># root中的属性一并修改</span></span><br><span class="line">print(root.get(<span class="string">"hello"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以转化为纯正的dict</span></span><br><span class="line">d = dict(root.attrib)</span><br><span class="line">print(d.items())</span><br></pre></td></tr></table></figure>

<pre><code>[(&#39;interesting&#39;, &#39;totally&#39;), (&#39;hello&#39;, &#39;Huhu&#39;)] [&#39;interesting&#39;, &#39;hello&#39;] [&#39;totally&#39;, &#39;Huhu&#39;]
None
Guten Tag
Guten Tag
dict_items([(&#39;interesting&#39;, &#39;totally&#39;), (&#39;hello&#39;, &#39;Guten Tag&#39;)])</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 元素中包含文本</span></span><br><span class="line">root = etree.Element(<span class="string">"root"</span>)</span><br><span class="line">root.text = <span class="string">"Hello World"</span></span><br><span class="line">print(root.text)</span><br><span class="line">print(etree.tostring(root))</span><br></pre></td></tr></table></figure>

<pre><code>Hello World
b&#39;&lt;root&gt;Hello World&lt;/root&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如何添加特殊元素类似于&lt;br/&gt;</span></span><br><span class="line">html = etree.Element(<span class="string">"html"</span>)</span><br><span class="line">body = etree.SubElement(html, <span class="string">"body"</span>)</span><br><span class="line">body.text = <span class="string">"TEXT"</span></span><br><span class="line"></span><br><span class="line">print(etree.tostring(html))</span><br><span class="line"></span><br><span class="line">br = etree.SubElement(body, <span class="string">"br"</span>)</span><br><span class="line">print(etree.tostring(html))</span><br><span class="line"></span><br><span class="line">br.tail = <span class="string">"TAIL"</span></span><br><span class="line">print(etree.tostring(html))</span><br><span class="line">body.text = <span class="string">"HEAD"</span></span><br><span class="line">print(etree.tostring(html))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;html&gt;&lt;body&gt;TEXT&lt;/body&gt;&lt;/html&gt;&#39;
b&#39;&lt;html&gt;&lt;body&gt;TEXT&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;&#39;
b&#39;&lt;html&gt;&lt;body&gt;TEXT&lt;br/&gt;TAIL&lt;/body&gt;&lt;/html&gt;&#39;
b&#39;&lt;html&gt;&lt;body&gt;HEAD&lt;br/&gt;TAIL&lt;/body&gt;&lt;/html&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tail其实属于前边元素的一部分</span></span><br><span class="line">print(etree.tostring(br))</span><br><span class="line">print(etree.tostring(br, with_tail=<span class="keyword">False</span>))</span><br><span class="line">print(etree.tostring(html, method=<span class="string">"text"</span>))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;br/&gt;TAIL&#39;
b&#39;&lt;br/&gt;&#39;
b&#39;HEADTAIL&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xpath方法也可以使用</span></span><br><span class="line">print(html.xpath(<span class="string">"string()"</span>))</span><br><span class="line">print(html.xpath(<span class="string">"//text()"</span>))</span><br></pre></td></tr></table></figure>

<pre><code>HEADTAIL
[&#39;HEAD&#39;, &#39;TAIL&#39;]</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 甚至可以吧xpath的方法包装成函数</span></span><br><span class="line">build_text_list = etree.XPath(<span class="string">"//text()"</span>) <span class="comment"># lxml.etree only!</span></span><br><span class="line">print(build_text_list(html))</span><br></pre></td></tr></table></figure>

<pre><code>[&#39;HEAD&#39;, &#39;TAIL&#39;]</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># text也可以找爸爸</span></span><br><span class="line">texts = build_text_list(html)</span><br><span class="line">print(texts[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">parent = texts[<span class="number">0</span>].getparent()</span><br><span class="line">print(parent.tag)</span><br><span class="line"></span><br><span class="line">print(texts[<span class="number">1</span>])</span><br><span class="line">print(texts[<span class="number">1</span>].getparent().tag)</span><br></pre></td></tr></table></figure>

<pre><code>HEAD
body
TAIL
br</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 判断一段文本是正常的文本还是tail</span></span><br><span class="line">print(texts[<span class="number">0</span>].is_text)</span><br><span class="line">print(texts[<span class="number">1</span>].is_text)</span><br><span class="line">print(texts[<span class="number">1</span>].is_tail)</span><br></pre></td></tr></table></figure>

<pre><code>True
False
True</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 但是XPath下有些方法就不行了</span></span><br><span class="line">stringify = etree.XPath(<span class="string">"string()"</span>)</span><br><span class="line">print(stringify(html))</span><br><span class="line">print(stringify(html).getparent())</span><br></pre></td></tr></table></figure>

<pre><code>HEADTAIL
None</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># etree中的树是iterable的</span></span><br><span class="line">root = etree.Element(<span class="string">"root"</span>)</span><br><span class="line">etree.SubElement(root, <span class="string">"child"</span>).text = <span class="string">"Child 1"</span></span><br><span class="line">etree.SubElement(root, <span class="string">"child"</span>).text = <span class="string">"Child 2"</span></span><br><span class="line">etree.SubElement(root, <span class="string">"another"</span>).text = <span class="string">"Child 3"</span></span><br><span class="line"></span><br><span class="line">print(etree.tostring(root, pretty_print=<span class="keyword">True</span>))</span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> root.iter():</span><br><span class="line">    print(<span class="string">"%s - %s"</span> % (element.tag, element.text))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;\n  &lt;child&gt;Child 1&lt;/child&gt;\n  &lt;child&gt;Child 2&lt;/child&gt;\n  &lt;another&gt;Child 3&lt;/another&gt;\n&lt;/root&gt;\n&#39;
root - None
child - Child 1
child - Child 2
another - Child 3</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以通过在iter中添加参数，来过滤输出的tag</span></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> root.iter(<span class="string">"child"</span>):</span><br><span class="line">    print(<span class="string">"%s - %s"</span> % (element.tag, element.text))</span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> root.iter(<span class="string">"another"</span>, <span class="string">"child"</span>):</span><br><span class="line">    print(<span class="string">"%s - %s"</span> % (element.tag, element.text))</span><br></pre></td></tr></table></figure>

<pre><code>child - Child 1
child - Child 2
child - Child 1
child - Child 2
another - Child 3</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认情况下，所有节点都会被遍历，如Entity、Comment等，通过添加tag参数可以避免这一点</span></span><br><span class="line">root.append(etree.Entity(<span class="string">"#234"</span>))</span><br><span class="line">root.append(etree.Comment(<span class="string">"some comment"</span>))</span><br><span class="line">print(etree.tostring(root))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> root.iter():</span><br><span class="line">    <span class="keyword">if</span> isinstance(element.tag, str):</span><br><span class="line">        print(<span class="string">"%s - %s"</span> % (element.tag, element.text))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"SPECIAL: %s - %s"</span> % (element, element.text))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> root.iter(tag=etree.Element):</span><br><span class="line">    print(<span class="string">"%s - %s"</span> % (element.tag, element.text))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> root.iter(tag=etree.Entity):</span><br><span class="line">    print(element.text)</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;&lt;child&gt;Child 1&lt;/child&gt;&lt;child&gt;Child 2&lt;/child&gt;&lt;another&gt;Child 3&lt;/another&gt;&amp;#234;&lt;!--some comment--&gt;&lt;/root&gt;&#39;
root - None
child - Child 1
child - Child 2
another - Child 3
SPECIAL: &amp;#234; - &amp;#234;
SPECIAL: &lt;!--some comment--&gt; - some comment
root - None
child - Child 1
child - Child 2
another - Child 3
&amp;#234;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过elementTreeName.write(filePath)可以把树写进文件或通过url传输</span></span><br><span class="line"><span class="comment"># 或者如果你只有elementName的话，可以这么写：</span></span><br><span class="line"><span class="comment"># etree.ElementTree(elementName).write(filePath)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单粗暴的直接写xml也可以</span></span><br><span class="line">root = etree.XML(</span><br><span class="line">   <span class="string">'&lt;html&gt;&lt;head/&gt;&lt;body&gt;&lt;p&gt;Hello&lt;br/&gt;World&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;'</span>)</span><br><span class="line"><span class="comment"># 通过method参数，可以序列化为不同格式，默认method = 'xml'</span></span><br><span class="line">print(etree.tostring(root))</span><br><span class="line">print(etree.tostring(root, method=<span class="string">'html'</span>))</span><br><span class="line">print(etree.tostring(root, method=<span class="string">'text'</span>))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;html&gt;&lt;head/&gt;&lt;body&gt;&lt;p&gt;Hello&lt;br/&gt;World&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&#39;
b&#39;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;Hello&lt;br&gt;World&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&#39;
b&#39;HelloWorld&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ElementTree class，是一个element的容器，提供了一些方法来对整个root node文档进行操作</span></span><br><span class="line">root = etree.XML(<span class="string">'''\</span></span><br><span class="line"><span class="string">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE root SYSTEM "test" [ &lt;!ENTITY tasty "parsnips"&gt; ]&gt;</span></span><br><span class="line"><span class="string">&lt;root&gt;</span></span><br><span class="line"><span class="string">  &lt;a&gt;&amp;tasty;&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/root&gt;</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line">tree = etree.ElementTree(root)</span><br><span class="line">print(tree.docinfo.xml_version)</span><br><span class="line">print(tree.docinfo.doctype)</span><br><span class="line"></span><br><span class="line">tree.docinfo.public_id = <span class="string">'-//W3C//DTD XHTML 1.0 Transitional//EN'</span></span><br><span class="line">tree.docinfo.system_url = <span class="string">'file://local.dtd'</span></span><br><span class="line">print(tree.docinfo.doctype)</span><br></pre></td></tr></table></figure>

<pre><code>1.0
&lt;!DOCTYPE root SYSTEM &quot;test&quot;&gt;
&lt;!DOCTYPE root PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;file://local.dtd&quot;&gt;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(etree.tostring(tree))</span><br><span class="line">print(etree.tostring(tree.getroot()))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;!DOCTYPE root PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;file://local.dtd&quot; [\n&lt;!ENTITY tasty &quot;parsnips&quot;&gt;\n]&gt;\n&lt;root&gt;\n  &lt;a&gt;parsnips&lt;/a&gt;\n&lt;/root&gt;&#39;
b&#39;&lt;root&gt;\n  &lt;a&gt;parsnips&lt;/a&gt;\n&lt;/root&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解析文档中以string读入的xml</span></span><br><span class="line">some_xml_data = <span class="string">"&lt;root&gt;data&lt;/root&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># .fromstring函数其实和.XML差不多</span></span><br><span class="line">root = etree.fromstring(some_xml_data)</span><br><span class="line">print(etree.tostring(root))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;data&lt;/root&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二进制读取解析</span></span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">some_file_or_file_like_object = BytesIO(<span class="string">b"&lt;root&gt;data&lt;/root&gt;"</span>)</span><br><span class="line">tree = etree.parse(some_file_or_file_like_object)</span><br><span class="line">print(etree.tostring(tree))</span><br><span class="line"><span class="comment"># 注意：parse函数返回的是ElementTree对象，不是Element，通过getroot可以转化为Element对象</span></span><br><span class="line"><span class="comment"># ElementTree和Element在某些方面相似，但是方法调用上不同，比如.tag只有Element可以使用</span></span><br><span class="line">root = tree.getroot()</span><br><span class="line">print(etree.tostring(root))</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">"tree执行:"</span>, tree.tag)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    print(<span class="string">"root执行:"</span>, root.tag)</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;data&lt;/root&gt;&#39;
b&#39;&lt;root&gt;data&lt;/root&gt;&#39;
root执行: root</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parser对象</span></span><br><span class="line">parser = etree.XMLParser(remove_blank_text=<span class="keyword">True</span>)</span><br><span class="line">root = etree.XML(<span class="string">"&lt;root&gt;  &lt;a/&gt;   &lt;b&gt;  &lt;/b&gt;     &lt;/root&gt;"</span>, parser)</span><br><span class="line">print(etree.tostring(root))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;&lt;a/&gt;&lt;b&gt;  &lt;/b&gt;&lt;/root&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Incremental parsing增量解析，比如在网络分步传输的场景下需要使用</span></span><br><span class="line"><span class="comment"># 方法一</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataSource</span>:</span></span><br><span class="line">    data = [ <span class="string">b"&lt;roo"</span>, <span class="string">b"t&gt;&lt;"</span>, <span class="string">b"a/"</span>, <span class="string">b"&gt;&lt;"</span>, <span class="string">b"/root&gt;"</span> ]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, requested_size)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> self.data.pop(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">b''</span></span><br><span class="line"></span><br><span class="line">        tree = etree.parse(DataSource())</span><br><span class="line">print(etree.tostring(tree))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line">parser = etree.XMLParser()</span><br><span class="line"></span><br><span class="line">parser.feed(<span class="string">"&lt;roo"</span>)</span><br><span class="line">parser.feed(<span class="string">"t&gt;&lt;"</span>)</span><br><span class="line">parser.feed(<span class="string">"a/"</span>)</span><br><span class="line">parser.feed(<span class="string">"&gt;&lt;"</span>)</span><br><span class="line">parser.feed(<span class="string">"/root&gt;"</span>)</span><br><span class="line"></span><br><span class="line">root = parser.close()</span><br><span class="line">print(etree.tostring(root))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;root&gt;data&lt;/root&gt;&#39;
b&#39;&lt;root&gt;&lt;a/&gt;&lt;/root&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Event-driven parsing事件驱动的解析，如只需要很大的树中的一小部分时使用</span></span><br><span class="line"><span class="comment"># 方法一</span></span><br><span class="line"><span class="comment"># iterparse默认只解析end事件</span></span><br><span class="line">some_file_like = BytesIO(<span class="string">b"&lt;root&gt;&lt;a&gt;data&lt;/a&gt;&lt;/root&gt;"</span>)</span><br><span class="line"><span class="keyword">for</span> event, element <span class="keyword">in</span> etree.iterparse(some_file_like):</span><br><span class="line">    print(<span class="string">"%s, %4s, %s"</span> % (event, element.tag, element.text))</span><br><span class="line">    </span><br><span class="line">print()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以修改events参数解析所有事件</span></span><br><span class="line">some_file_like = BytesIO(<span class="string">b"&lt;root&gt;&lt;a&gt;data&lt;/a&gt;&lt;/root&gt;"</span>)</span><br><span class="line"><span class="keyword">for</span> event, element <span class="keyword">in</span> etree.iterparse(some_file_like,</span><br><span class="line">                                      events=(<span class="string">"start"</span>, <span class="string">"end"</span>)):</span><br><span class="line">    print(<span class="string">"%5s, %4s, %s"</span> % (event, element.tag, element.text))</span><br></pre></td></tr></table></figure>

<pre><code>end,    a, data
end, root, None

start, root, None
start,    a, data
  end,    a, data
  end, root, None</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法二</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParserTarget</span>:</span></span><br><span class="line">    events = []</span><br><span class="line">    close_count = <span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, tag, attrib)</span>:</span></span><br><span class="line">        self.events.append((<span class="string">"start"</span>, tag, attrib))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        events, self.events = self.events, []</span><br><span class="line">        self.close_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> events</span><br><span class="line"></span><br><span class="line">parser_target = ParserTarget()</span><br><span class="line"></span><br><span class="line">parser = etree.XMLParser(target=parser_target)</span><br><span class="line">events = etree.fromstring(<span class="string">'&lt;root test="true"/&gt;'</span>, parser)</span><br><span class="line"></span><br><span class="line">print(parser_target.close_count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    print(<span class="string">'event: %s - tag: %s'</span> % (event[<span class="number">0</span>], event[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">for</span> attr, value <span class="keyword">in</span> event[<span class="number">2</span>].items():</span><br><span class="line">        print(<span class="string">' * %s = %s'</span> % (attr, value))</span><br></pre></td></tr></table></figure>

<pre><code>1
event: start - tag: root
 * test = true


/Users/imonce/anaconda/lib/python3.6/site-packages/ipykernel_launcher.py:15: DeprecationWarning: inspect.getargspec() is deprecated, use inspect.signature() or inspect.getfullargspec()
  from ipykernel import kernelapp as app</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">events = etree.fromstring(<span class="string">'&lt;root test="true"/&gt;'</span>, parser)</span><br><span class="line">print(parser_target.close_count)</span><br><span class="line">events = etree.fromstring(<span class="string">'&lt;root test="true"/&gt;'</span>, parser)</span><br><span class="line">print(parser_target.close_count)</span><br></pre></td></tr></table></figure>

<pre><code>2
3</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">    print(<span class="string">'event: %s - tag: %s'</span> % (event[<span class="number">0</span>], event[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">for</span> attr, value <span class="keyword">in</span> event[<span class="number">2</span>].items():</span><br><span class="line">        print(<span class="string">' * %s = %s'</span> % (attr, value))</span><br></pre></td></tr></table></figure>

<pre><code>event: start - tag: root
 * test = true</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># namespace命名空间，格式为：&#123;namespace_name&#125;tag_name</span></span><br><span class="line"><span class="comment"># 一般是链接，空链接的话会 ns+编号 给一个代号</span></span><br><span class="line"><span class="comment"># a:b的tag名会直接报错</span></span><br><span class="line">xhtml = etree.Element(<span class="string">"&#123;http://www.w3.org/1999/test&#125;testhtml"</span>)</span><br><span class="line">body = etree.SubElement(xhtml, <span class="string">"&#123;http://www.w3.org/1999/test&#125;tbody"</span>)</span><br><span class="line">body.text = <span class="string">"Hello World"</span></span><br><span class="line"></span><br><span class="line">print(etree.tostring(xhtml))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 高贵的html</span></span><br><span class="line">xhtml = etree.Element(<span class="string">"&#123;http://www.w3.org/1999/xhtml&#125;html"</span>)</span><br><span class="line">body = etree.SubElement(xhtml, <span class="string">"&#123;http://www.w3.org/1999/xhtml&#125;body"</span>)</span><br><span class="line">body.text = <span class="string">"Hello World"</span></span><br><span class="line"></span><br><span class="line">print(etree.tostring(xhtml))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;ns0:testhtml xmlns:ns0=&quot;http://www.w3.org/1999/test&quot;&gt;&lt;ns0:tbody&gt;Hello World&lt;/ns0:tbody&gt;&lt;/ns0:testhtml&gt;&#39;
b&#39;&lt;html:html xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;html:body&gt;Hello World&lt;/html:body&gt;&lt;/html:html&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置默认命名空间</span></span><br><span class="line">XHTML_NAMESPACE = <span class="string">"http://www.w3.org/1999/xhtml"</span></span><br><span class="line">XHTML = <span class="string">"&#123;%s&#125;"</span> % XHTML_NAMESPACE</span><br><span class="line"></span><br><span class="line">NSMAP = &#123;<span class="keyword">None</span> : XHTML_NAMESPACE&#125; <span class="comment"># the default namespace (no prefix)</span></span><br><span class="line">xhtml = etree.Element(XHTML + <span class="string">"html"</span>, nsmap=NSMAP) <span class="comment"># lxml only!</span></span><br><span class="line">body = etree.SubElement(xhtml, XHTML + <span class="string">"body"</span>)</span><br><span class="line">body.text = <span class="string">"Hello World"</span></span><br><span class="line">print(etree.tostring(xhtml))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;body&gt;Hello World&lt;/body&gt;&lt;/html&gt;&#39;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># QName方法，快速合成或提取namespace</span></span><br><span class="line">tag = etree.QName(<span class="string">'http://www.w3.org/1999/xhtml'</span>, <span class="string">'html'</span>)</span><br><span class="line">print(tag.localname)</span><br><span class="line">print(tag.namespace)</span><br><span class="line">print(tag.text)</span><br><span class="line"></span><br><span class="line">root = etree.Element(<span class="string">'&#123;http://www.w3.org/1999/xhtml&#125;html'</span>)</span><br><span class="line">tag = etree.QName(root)</span><br><span class="line">print(tag.localname)</span><br></pre></td></tr></table></figure>

<pre><code>html
http://www.w3.org/1999/xhtml
{http://www.w3.org/1999/xhtml}html
html</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nsmap方法，直接提取命名空间字典</span></span><br><span class="line">print(xhtml.nsmap)</span><br></pre></td></tr></table></figure>

<pre><code>{None: &#39;http://www.w3.org/1999/xhtml&#39;}</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 子元素继承父元素命名空间</span></span><br><span class="line">root = etree.Element(<span class="string">'root'</span>, nsmap=&#123;<span class="string">'a'</span>: <span class="string">'http://a.b/c'</span>&#125;)</span><br><span class="line">child = etree.SubElement(root, <span class="string">'child'</span>,</span><br><span class="line">                         nsmap=&#123;<span class="string">'b'</span>: <span class="string">'http://b.c/d'</span>&#125;)</span><br><span class="line">print(root.nsmap)</span><br><span class="line">print(child.nsmap)</span><br></pre></td></tr></table></figure>

<pre><code>{&#39;a&#39;: &#39;http://a.b/c&#39;}
{&#39;b&#39;: &#39;http://b.c/d&#39;, &#39;a&#39;: &#39;http://a.b/c&#39;}</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加带命名空间的属性，格式为：set(&#123;namespace_name&#125;attr_name, attr_value)</span></span><br><span class="line">body.set(XHTML + <span class="string">"bgcolor"</span>, <span class="string">"#CCFFAA"</span>)</span><br><span class="line">print(etree.tostring(xhtml))</span><br><span class="line"><span class="comment"># 注意：get的时候也要带命名空间</span></span><br><span class="line">print(body.get(<span class="string">"bgcolor"</span>))</span><br><span class="line">print(body.get(XHTML+<span class="string">"bgcolor"</span>))</span><br></pre></td></tr></table></figure>

<pre><code>b&#39;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;body xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot; html:bgcolor=&quot;#CCFFAA&quot;&gt;Hello World&lt;/body&gt;&lt;/html&gt;&#39;
None
#CCFFAA</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 也可以用XPath</span></span><br><span class="line">find_xhtml_body = etree.ETXPath(      <span class="comment"># lxml only !</span></span><br><span class="line">    <span class="string">"//&#123;%s&#125;body"</span> % XHTML_NAMESPACE)</span><br><span class="line">results = find_xhtml_body(xhtml)</span><br><span class="line"></span><br><span class="line">print(results[<span class="number">0</span>].tag)</span><br></pre></td></tr></table></figure>

<pre><code>{http://www.w3.org/1999/xhtml}body</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iter的话也要考虑namespace</span></span><br><span class="line"><span class="keyword">for</span> el <span class="keyword">in</span> xhtml.iter(<span class="string">'&#123;*&#125;body'</span>): print(el.tag)</span><br></pre></td></tr></table></figure>

<pre><code>{http://www.w3.org/1999/xhtml}body</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># E-factory：提供一种简单紧凑的语法来生成XML和HTML</span></span><br><span class="line"><span class="keyword">from</span> lxml.builder <span class="keyword">import</span> E</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CLASS</span><span class="params">(*args)</span>:</span> <span class="comment"># class 是python中的保留字，无法直接当做属性名</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"class"</span>:<span class="string">' '</span>.join(args)&#125;</span><br><span class="line"></span><br><span class="line">html = page = (</span><br><span class="line">  E.html(       <span class="comment"># create an Element called "html"</span></span><br><span class="line">    E.head(</span><br><span class="line">      E.title(<span class="string">"This is a sample document"</span>)</span><br><span class="line">    ),</span><br><span class="line">    E.body(</span><br><span class="line">      E.h1(<span class="string">"Hello!"</span>, CLASS(<span class="string">"title"</span>)),</span><br><span class="line">      E.p(<span class="string">"This is a paragraph with "</span>, E.b(<span class="string">"bold"</span>), <span class="string">" text in it!"</span>),</span><br><span class="line">      E.p(<span class="string">"This is another paragraph, with a"</span>, <span class="string">"\n      "</span>,</span><br><span class="line">        E.a(<span class="string">"link"</span>, href=<span class="string">"http://www.python.org"</span>), <span class="string">"."</span>),</span><br><span class="line">      E.p(<span class="string">"Here are some reserved characters: &lt;spam&amp;egg&gt;."</span>),</span><br><span class="line">      etree.XML(<span class="string">"&lt;p&gt;And finally an embedded XHTML fragment.&lt;/p&gt;"</span>),</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">print(str(etree.tostring(page, pretty_print=<span class="keyword">True</span>),encoding=<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>

<pre><code>&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;This is a sample document&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1 class=&quot;title&quot;&gt;Hello!&lt;/h1&gt;
    &lt;p&gt;This is a paragraph with &lt;b&gt;bold&lt;/b&gt; text in it!&lt;/p&gt;
    &lt;p&gt;This is another paragraph, with a
      &lt;a href=&quot;http://www.python.org&quot;&gt;link&lt;/a&gt;.&lt;/p&gt;
    &lt;p&gt;Here are some reserved characters: &amp;lt;spam&amp;amp;egg&amp;gt;.&lt;/p&gt;
    &lt;p&gt;And finally an embedded XHTML fragment.&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此外还有一种基于属性的方法</span></span><br><span class="line"><span class="keyword">from</span> lxml.builder <span class="keyword">import</span> ElementMaker <span class="comment"># lxml only !</span></span><br><span class="line"></span><br><span class="line">E = ElementMaker(namespace=<span class="string">"http://my.de/fault/namespace"</span>,</span><br><span class="line">                 nsmap=&#123;<span class="string">'p'</span> : <span class="string">"http://my.de/fault/namespace"</span>&#125;)</span><br><span class="line"></span><br><span class="line">DOC = E.doc</span><br><span class="line">TITLE = E.title</span><br><span class="line">SECTION = E.section</span><br><span class="line">PAR = E.par</span><br><span class="line"></span><br><span class="line">my_doc = DOC(</span><br><span class="line">  TITLE(<span class="string">"The dog and the hog"</span>),</span><br><span class="line">  SECTION(</span><br><span class="line">    TITLE(<span class="string">"The dog"</span>, tType=<span class="string">'title'</span>),</span><br><span class="line">    PAR(<span class="string">"Once upon a time, ..."</span>),</span><br><span class="line">    PAR(<span class="string">"And then ..."</span>)</span><br><span class="line">  ),</span><br><span class="line">  SECTION(</span><br><span class="line">    TITLE(<span class="string">"The hog"</span>),</span><br><span class="line">    PAR(<span class="string">"Sooner or later ..."</span>)</span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">print(str(etree.tostring(my_doc, pretty_print=<span class="keyword">True</span>),encoding=<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>

<pre><code>&lt;p:doc xmlns:p=&quot;http://my.de/fault/namespace&quot;&gt;
  &lt;p:title&gt;The dog and the hog&lt;/p:title&gt;
  &lt;p:section&gt;
    &lt;p:title tType=&quot;title&quot;&gt;The dog&lt;/p:title&gt;
    &lt;p:par&gt;Once upon a time, ...&lt;/p:par&gt;
    &lt;p:par&gt;And then ...&lt;/p:par&gt;
  &lt;/p:section&gt;
  &lt;p:section&gt;
    &lt;p:title&gt;The hog&lt;/p:title&gt;
    &lt;p:par&gt;Sooner or later ...&lt;/p:par&gt;
  &lt;/p:section&gt;
&lt;/p:doc&gt;</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># XPath的一些例子</span></span><br><span class="line">root = etree.XML(<span class="string">"&lt;root&gt;&lt;a x='123'&gt;aText&lt;b/&gt;&lt;c/&gt;&lt;b/&gt;&lt;/a&gt;&lt;/root&gt;"</span>)</span><br><span class="line"><span class="comment"># 找儿子（单层子节点）</span></span><br><span class="line">print(root.find(<span class="string">"b"</span>))</span><br><span class="line">print(root.find(<span class="string">"a"</span>).tag)</span><br></pre></td></tr></table></figure>

<pre><code>None
a</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找孩子（所有子节点）</span></span><br><span class="line">print(root.find(<span class="string">".//b"</span>).tag)</span><br></pre></td></tr></table></figure>

<pre><code>b</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 带属性找孩子</span></span><br><span class="line">print(root.findall(<span class="string">".//a[@x]"</span>)[<span class="number">0</span>].tag)</span><br></pre></td></tr></table></figure>

<pre><code>a</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过ElementTree找路径</span></span><br><span class="line">tree = etree.ElementTree(root)</span><br><span class="line">a = root[<span class="number">0</span>]</span><br><span class="line">print(tree.getelementpath(a[<span class="number">0</span>]))</span><br><span class="line">print(tree.getelementpath(a[<span class="number">1</span>]))</span><br><span class="line">print(tree.getelementpath(a[<span class="number">2</span>]))</span><br></pre></td></tr></table></figure>

<pre><code>a/b[1]
a/c
a/b[2]</code></pre>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/10/21/通过TensorFlow实现word-embedding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/21/通过TensorFlow实现word-embedding/" class="post-title-link" itemprop="url">通过TensorFlow实现word embedding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-21 10:16:01" itemprop="dateCreated datePublished" datetime="2019-10-21T10:16:01+08:00">2019-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-04 16:02:49" itemprop="dateModified" datetime="2020-01-04T16:02:49+08:00">2020-01-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/10/21/通过TensorFlow实现word-embedding/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/10/21/通过TensorFlow实现word-embedding/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <p>word2vec的方法主要分为CBOW（Continuous Bag Of Words）和skip-gram（n-gram）两大类。</p>
<p>两种方法互为镜像。简单来说，CBOW是通过上下文预测中间值来进行训练的，skip-gram是通过中间值预测上下文来进行训练的。</p>
<p>这里，我们使用skip-gram的方法。</p>
<h1 id="python脚本"><a href="#python脚本" class="headerlink" title="python脚本"></a>python脚本</h1><p>IDE: jupyter notebook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.manifold <span class="keyword">import</span> TSNE</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> six.moves <span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> six.moves <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicPatternEmbedding</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.url = <span class="string">'http://mattmahoney.net/dc/'</span></span><br><span class="line">        self.data_index = <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        self.vocabulary_size = <span class="number">5000</span></span><br><span class="line">        </span><br><span class="line">        self.batch_size = <span class="number">128</span></span><br><span class="line">        self.embedding_size = <span class="number">128</span>  <span class="comment"># Dimension of the embedding vector.</span></span><br><span class="line">        self.skip_window = <span class="number">1</span>       <span class="comment"># How many words to consider left and right.</span></span><br><span class="line">        self.num_skips = <span class="number">2</span>         <span class="comment"># How many times to reuse an input to generate a label.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># We pick a random validation set to sample nearest neighbors. Here we limit the</span></span><br><span class="line">        <span class="comment"># validation samples to the words that have a low numeric ID, which by</span></span><br><span class="line">        <span class="comment"># construction are also the most frequent.</span></span><br><span class="line">        self.valid_size = <span class="number">16</span>     <span class="comment"># Random set of words to evaluate similarity on.</span></span><br><span class="line">        self.valid_window = <span class="number">100</span>  <span class="comment"># Only pick dev samples in the head of the distribution.</span></span><br><span class="line">        <span class="comment"># choose 16 numbers from 0 to 99 randomly</span></span><br><span class="line">        self.valid_examples = np.random.choice(self.valid_window, self.valid_size, replace=<span class="keyword">False</span>)</span><br><span class="line">        self.num_sampled = <span class="number">64</span>    <span class="comment"># Number of negative examples to sample.</span></span><br><span class="line">        self.num_steps = <span class="number">10001</span></span><br><span class="line">        </span><br><span class="line">        self.final_embedding = <span class="keyword">None</span></span><br><span class="line">        </span><br><span class="line">        self.graph = tf.Graph()</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># download and verify the dataset file</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maybe_download</span><span class="params">(self, filename, expected_bytes)</span>:</span></span><br><span class="line">        <span class="comment"># If the dataset file is not under the current path, download it directly</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(filename):</span><br><span class="line">            filename, _ = urllib.request.urlretrieve(self.url + filename, filename)</span><br><span class="line">        <span class="comment"># get dataset file infomationn</span></span><br><span class="line">        statinfo = os.stat(filename)</span><br><span class="line">        <span class="comment"># verify file size</span></span><br><span class="line">        <span class="keyword">if</span> statinfo.st_size == expected_bytes:</span><br><span class="line">            print(<span class="string">'Found and verified'</span>, filename)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(statinfo.st_size)</span><br><span class="line">            <span class="keyword">raise</span> Exception(</span><br><span class="line">                <span class="string">'Failed to verify '</span> + filename + <span class="string">'. Can you get to it with a browser?'</span>)</span><br><span class="line">        <span class="keyword">return</span> filename</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># read the data from zip into a list of strings</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_data</span><span class="params">(self, filename)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> zipfile.ZipFile(filename) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="comment"># separate by default separators, that is, all null characters, including spaces, newlines (\n), tabs (\t), etc.</span></span><br><span class="line">            data = tf.compat.as_str(f.read(f.namelist()[<span class="number">0</span>])).split()</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># process raw inputs into a dataset</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_dataset</span><span class="params">(self, words)</span>:</span></span><br><span class="line">        <span class="comment"># add unknown words into count list</span></span><br><span class="line">        count = [[<span class="string">'UNK'</span>, <span class="number">-1</span>]]</span><br><span class="line">        <span class="comment"># count the words list and add the pairs (word_name, number) into count list</span></span><br><span class="line">        count.extend(collections.Counter(words).most_common(self.vocabulary_size - <span class="number">1</span>))</span><br><span class="line">        dictionary = dict()</span><br><span class="line">        <span class="comment"># create a dictionary of the words with serial number</span></span><br><span class="line">        <span class="keyword">for</span> word, _ <span class="keyword">in</span> count:</span><br><span class="line">            dictionary[word] = len(dictionary)</span><br><span class="line">        data = list()</span><br><span class="line">        unk_count = <span class="number">0</span></span><br><span class="line">        <span class="comment"># convert the word list into a number list, 0 for unknown words</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">            <span class="keyword">if</span> word <span class="keyword">in</span> dictionary:</span><br><span class="line">                index = dictionary[word]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                index = <span class="number">0</span></span><br><span class="line">                unk_count += <span class="number">1</span></span><br><span class="line">            data.append(index)</span><br><span class="line">        <span class="comment"># update the number of UNK</span></span><br><span class="line">        count[<span class="number">0</span>][<span class="number">1</span>] = unk_count</span><br><span class="line">        <span class="comment"># generate a new dictionary by exchanging key and value</span></span><br><span class="line">        reversed_dictionary = dict(zip(dictionary.values(), dictionary.keys()))</span><br><span class="line">        <span class="keyword">return</span> data, count, dictionary, reversed_dictionary</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># function to generate a training batch for the skip-gram model</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_batch</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="comment"># make sure the data length is OK</span></span><br><span class="line">        <span class="keyword">assert</span> self.batch_size % self.num_skips == <span class="number">0</span></span><br><span class="line">        <span class="keyword">assert</span> self.num_skips &lt;= <span class="number">2</span> * self.skip_window</span><br><span class="line"></span><br><span class="line">        batch = np.ndarray(shape=(self.batch_size), dtype=np.int32)</span><br><span class="line">        labels = np.ndarray(shape=(self.batch_size, <span class="number">1</span>), dtype=np.int32)</span><br><span class="line">        span = <span class="number">2</span> * self.skip_window + <span class="number">1</span>  <span class="comment"># [ skip_window target skip_window ]</span></span><br><span class="line">        <span class="comment"># create a new double-ended queue to store the buffer</span></span><br><span class="line">        buffer = collections.deque(maxlen=span)</span><br><span class="line">        <span class="comment"># data_index indicates the end point of the current window</span></span><br><span class="line">        <span class="keyword">if</span> self.data_index + span &gt; len(data):</span><br><span class="line">            data_index = <span class="number">0</span></span><br><span class="line">        buffer.extend(data[self.data_index:self.data_index + span])</span><br><span class="line">        self.data_index += span</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.batch_size // self.num_skips):</span><br><span class="line">            target = self.skip_window  <span class="comment"># target label at the center of the buffer</span></span><br><span class="line">            targets_to_avoid = [self.skip_window]</span><br><span class="line">            <span class="comment"># sample num_skips batches and labels, optimizable</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(self.num_skips):</span><br><span class="line">                <span class="keyword">while</span> target <span class="keyword">in</span> targets_to_avoid:</span><br><span class="line">                    target = random.randint(<span class="number">0</span>, span - <span class="number">1</span>)</span><br><span class="line">                <span class="comment"># avoid sampling to the same target</span></span><br><span class="line">                targets_to_avoid.append(target)</span><br><span class="line">                <span class="comment"># each batch item stands for input</span></span><br><span class="line">                batch[i * self.num_skips + j] = buffer[self.skip_window]</span><br><span class="line">                <span class="comment"># each label item stands for ground truth</span></span><br><span class="line">                labels[i * self.num_skips + j, <span class="number">0</span>] = buffer[target]</span><br><span class="line">            <span class="keyword">if</span> self.data_index == len(data):</span><br><span class="line">                buffer[:] = data[:span]</span><br><span class="line">                self.data_index = span</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                buffer.append(data[self.data_index])</span><br><span class="line">                self.data_index += <span class="number">1</span></span><br><span class="line">        <span class="comment"># Backtrack a little bit to avoid skipping words in the end of a batch</span></span><br><span class="line">        self.data_index = self.data_index - span</span><br><span class="line">        <span class="keyword">return</span> batch, labels</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(self, data, reverse_dictionary)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.graph.as_default():</span><br><span class="line">            train_inputs = tf.placeholder(tf.int32, shape=[self.batch_size])</span><br><span class="line">            train_labels = tf.placeholder(tf.int32, shape=[self.batch_size, <span class="number">1</span>])</span><br><span class="line">            valid_dataset = tf.constant(self.valid_examples, dtype=tf.int32)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Ops and variables pinned to the CPU</span></span><br><span class="line">            <span class="keyword">with</span> tf.device(<span class="string">'/cpu:0'</span>):</span><br><span class="line">                <span class="comment"># Look up embeddings for inputs.</span></span><br><span class="line">                embeddings = tf.Variable(tf.random_uniform([self.vocabulary_size, self.embedding_size], <span class="number">-1.0</span>, <span class="number">1.0</span>))</span><br><span class="line">                <span class="comment"># according to embeddings, the 128-dimensional vector corresponding to the input word(train inputs) was extracted</span></span><br><span class="line">                embed = tf.nn.embedding_lookup(embeddings, train_inputs)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Construct the variables for the NCE loss</span></span><br><span class="line">                nce_weights = tf.Variable(tf.truncated_normal([self.vocabulary_size, self.embedding_size], stddev=<span class="number">1.0</span> / math.sqrt(self.embedding_size)))</span><br><span class="line">                nce_biases = tf.Variable(tf.zeros([self.vocabulary_size]))</span><br><span class="line">            <span class="comment"># Compute the average NCE loss for the batch.</span></span><br><span class="line">            <span class="comment"># tf.nce_loss automatically draws a new sample of the negative labels each</span></span><br><span class="line">            <span class="comment"># time we evaluate the loss.</span></span><br><span class="line">            loss = tf.reduce_mean(</span><br><span class="line">                tf.nn.nce_loss(weights=nce_weights,</span><br><span class="line">                             biases=nce_biases,</span><br><span class="line">                             labels=train_labels,</span><br><span class="line">                             inputs=embed,</span><br><span class="line">                             num_sampled=self.num_sampled,</span><br><span class="line">                             num_classes=self.vocabulary_size))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Construct the SGD optimizer using a learning rate of 1.0.</span></span><br><span class="line">            optimizer = tf.train.GradientDescentOptimizer(<span class="number">1.0</span>).minimize(loss)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Compute the cosine similarity between minibatch examples and all embeddings.</span></span><br><span class="line">            norm = tf.sqrt(tf.reduce_sum(tf.square(embeddings), <span class="number">1</span>, keep_dims=<span class="keyword">True</span>))</span><br><span class="line">            normalized_embeddings = embeddings / norm</span><br><span class="line">            valid_embeddings = tf.nn.embedding_lookup(normalized_embeddings, valid_dataset)</span><br><span class="line">            similarity = tf.matmul(valid_embeddings, normalized_embeddings, transpose_b=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Add variable initializer.</span></span><br><span class="line">            init = tf.global_variables_initializer()</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">with</span> tf.Session(graph = self.graph) <span class="keyword">as</span> session:</span><br><span class="line">            init.run()</span><br><span class="line">            average_loss = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> step <span class="keyword">in</span> xrange(self.num_steps):</span><br><span class="line">                batch_inputs, batch_labels = self.generate_batch(data)</span><br><span class="line">                feed_dict = &#123;train_inputs: batch_inputs, train_labels: batch_labels&#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment"># we perform one update step by evaluating the optimizer op (including it</span></span><br><span class="line">                <span class="comment"># in the list of returned values for session.run()</span></span><br><span class="line">                _, loss_val = session.run([optimizer, loss], feed_dict=feed_dict)</span><br><span class="line">                average_loss += loss_val</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> step % <span class="number">2000</span> == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> step &gt; <span class="number">0</span>:</span><br><span class="line">                        average_loss /= <span class="number">2000</span></span><br><span class="line">                    <span class="comment"># the average loss is an estimate of the loss over the last 2000 batches.</span></span><br><span class="line">                    print(<span class="string">'Average loss at step '</span>, step, <span class="string">': '</span>, average_loss)</span><br><span class="line">                    average_loss = <span class="number">0</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># output the most similar eight words to the screen</span></span><br><span class="line">                <span class="keyword">if</span> step % <span class="number">10000</span> == <span class="number">0</span>:</span><br><span class="line">                    sim = similarity.eval()</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(self.valid_size):</span><br><span class="line">                        valid_word = reverse_dictionary[self.valid_examples[i]]</span><br><span class="line">                        top_k = <span class="number">8</span>  <span class="comment"># number of nearest neighbors</span></span><br><span class="line">                        nearest = (-sim[i, :]).argsort()[<span class="number">1</span>:top_k + <span class="number">1</span>]</span><br><span class="line">                        log_str = <span class="string">'Nearest to %s:'</span> % valid_word</span><br><span class="line">                        <span class="keyword">for</span> k <span class="keyword">in</span> xrange(top_k):</span><br><span class="line">                            close_word = reverse_dictionary[nearest[k]]</span><br><span class="line">                            log_str = <span class="string">'%s %s,'</span> % (log_str, close_word)</span><br><span class="line">                        print(log_str)</span><br><span class="line">                        </span><br><span class="line">            self.final_embeddings = normalized_embeddings.eval()</span><br><span class="line">            </span><br><span class="line">    <span class="comment"># visualize the embeddings</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">plot_with_labels</span><span class="params">(self, low_dim_embs, labels, filename=<span class="string">'tsne.png'</span>)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> low_dim_embs.shape[<span class="number">0</span>] &gt;= len(labels), <span class="string">'More labels than embeddings'</span></span><br><span class="line">        plt.figure(figsize=(<span class="number">18</span>, <span class="number">18</span>))  <span class="comment"># in inches</span></span><br><span class="line">        <span class="keyword">for</span> i, label <span class="keyword">in</span> enumerate(labels):</span><br><span class="line">            x, y = low_dim_embs[i, :]</span><br><span class="line">            plt.scatter(x, y)</span><br><span class="line">            plt.annotate(label,</span><br><span class="line">                            xy=(x, y),</span><br><span class="line">                            xytext=(<span class="number">5</span>, <span class="number">2</span>),</span><br><span class="line">                            textcoords=<span class="string">'offset points'</span>,</span><br><span class="line">                            ha=<span class="string">'right'</span>,</span><br><span class="line">                            va=<span class="string">'bottom'</span>)</span><br><span class="line">        plt.show()</span><br><span class="line">        <span class="comment">#plt.savefig(filename)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bpe = BasicPatternEmbedding()</span><br><span class="line">        filename = bpe.maybe_download(<span class="string">'text8.zip'</span>,<span class="number">31344016</span>)</span><br><span class="line">        vocabulary = bpe.read_data(filename)</span><br><span class="line">        print(<span class="string">'Data size'</span>, len(vocabulary))</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">'vocabulary:'</span>, vocabulary[:<span class="number">10</span>])</span><br><span class="line">        </span><br><span class="line">        data, count, dictionary, reverse_dictionary = bpe.build_dataset(vocabulary)</span><br><span class="line">        <span class="keyword">del</span> vocabulary  <span class="comment"># Hint to reduce memory.</span></span><br><span class="line">        print(<span class="string">'Most common words (+UNK)'</span>, count[:<span class="number">5</span>])</span><br><span class="line">        print(<span class="string">'Sample data'</span>, data[:<span class="number">10</span>], [reverse_dictionary[i] <span class="keyword">for</span> i <span class="keyword">in</span> data[:<span class="number">10</span>]])</span><br><span class="line">        </span><br><span class="line">        batch, labels = bpe.generate_batch(data)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">            print(batch[i], reverse_dictionary[batch[i]], <span class="string">'-&gt;'</span>, labels[i, <span class="number">0</span>], reverse_dictionary[labels[i, <span class="number">0</span>]])</span><br><span class="line">        <span class="keyword">print</span> (dictionary[<span class="string">'a'</span>], dictionary[<span class="string">'as'</span>], dictionary[<span class="string">'term'</span>])</span><br><span class="line">        </span><br><span class="line">        bpe.train(data, reverse_dictionary)</span><br><span class="line">        </span><br><span class="line">        tsne = TSNE(perplexity=<span class="number">30</span>, n_components=<span class="number">2</span>, init=<span class="string">'pca'</span>, n_iter=<span class="number">5000</span>, method=<span class="string">'exact'</span>)</span><br><span class="line">        plot_only = <span class="number">300</span></span><br><span class="line">        low_dim_embs = tsne.fit_transform(bpe.final_embeddings[:plot_only, :])</span><br><span class="line"></span><br><span class="line">        labels = [reverse_dictionary[i] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(plot_only)]</span><br><span class="line">        bpe.plot_with_labels(low_dim_embs, labels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        print(<span class="string">'Please install sklearn, matplotlib, and scipy to show embeddings.'</span>)</span><br></pre></td></tr></table></figure>

<pre><code>Found and verified text8.zip
Data size 17005207
vocabulary: [&#39;anarchism&#39;, &#39;originated&#39;, &#39;as&#39;, &#39;a&#39;, &#39;term&#39;, &#39;of&#39;, &#39;abuse&#39;, &#39;first&#39;, &#39;used&#39;, &#39;against&#39;]
Most common words (+UNK) [[&#39;UNK&#39;, 2735459], (&#39;the&#39;, 1061396), (&#39;of&#39;, 593677), (&#39;and&#39;, 416629), (&#39;one&#39;, 411764)]
Sample data [0, 3081, 12, 6, 195, 2, 3134, 46, 59, 156] [&#39;UNK&#39;, &#39;originated&#39;, &#39;as&#39;, &#39;a&#39;, &#39;term&#39;, &#39;of&#39;, &#39;abuse&#39;, &#39;first&#39;, &#39;used&#39;, &#39;against&#39;]
3081 originated -&gt; 12 as
3081 originated -&gt; 0 UNK
12 as -&gt; 6 a
12 as -&gt; 3081 originated
6 a -&gt; 195 term
6 a -&gt; 12 as
195 term -&gt; 2 of
195 term -&gt; 6 a
6 12 195
Average loss at step  0 :  185.77481079101562
Nearest to it: confidence, doesn, theatre, came, gulf, cultural, sites, corps,
Nearest to use: buried, grave, observation, dust, batman, security, hungarian, opens,
Nearest to at: warrior, total, rivers, yards, reaction, extinction, exclusively, eu,
Nearest to if: emergency, present, developing, dates, life, for, pennsylvania, genesis,
Nearest to between: grant, execution, generally, power, official, interpreted, hiv, binary,
Nearest to people: unlikely, mainly, prussian, dedicated, shot, spending, dangerous, pick,
Nearest to states: forward, racing, begins, printed, follow, vacuum, study, mythology,
Nearest to by: rulers, protestant, marvel, republic, zero, letters, researchers, amiga,
Nearest to american: hit, stores, managed, practiced, intermediate, retrieved, moreover, unique,
Nearest to world: leadership, decay, culture, false, vii, et, dialogue, gave,
Nearest to but: denominations, passing, according, germans, medical, emperors, working, grant,
Nearest to an: removed, marxist, experts, ac, eugene, bones, tree, ne,
Nearest to were: coat, facing, grammar, storage, teach, covering, solomon, circuit,
Nearest to to: plant, supporting, pay, pp, shell, problem, acids, post,
Nearest to be: judah, photo, films, both, senate, woman, villages, eating,
Nearest to used: legislative, hero, private, organ, spaces, vice, top, trivia,
Average loss at step  2000 :  22.257665908694268
Average loss at step  4000 :  5.249317247629166
Average loss at step  6000 :  4.652066127896309
Average loss at step  8000 :  4.529780765414238
Average loss at step  10000 :  4.432040006399155
Nearest to it: he, came, votes, matters, doesn, whole, confidence, continues,
Nearest to use: alien, buried, security, hungarian, grave, dust, batman, amount,
Nearest to at: in, killed, appearance, extinction, mathbf, rivers, eu, pronunciation,
Nearest to if: life, molecules, emergency, dates, present, pennsylvania, for, rates,
Nearest to between: eight, execution, vs, of, hiv, grant, official, documentary,
Nearest to people: UNK, mainly, dedicated, selection, unlikely, shot, fact, dangerous,
Nearest to states: forward, racing, cover, arithmetic, study, vacuum, vs, begins,
Nearest to by: and, as, in, infant, co, manufacturer, with, campaign,
Nearest to american: hit, importance, austin, entry, depending, retrieved, vs, intermediate,
Nearest to world: culture, leadership, UNK, false, mathbf, skills, et, titled,
Nearest to but: and, medical, working, was, connecticut, vs, europeans, denominations,
Nearest to an: the, ac, plant, challenge, experts, necessary, lake, marxist,
Nearest to were: jpg, are, facing, covering, manual, circuit, opposite, test,
Nearest to to: ends, and, plant, in, office, into, supporting, agave,
Nearest to be: iso, shorter, judah, self, painter, also, dependent, assistance,
Nearest to used: opposition, hero, private, illinois, legislative, regime, breaking, repeated,</code></pre>
<p><img src="https://raw.githubusercontent.com/imonce/imgs/master/20191021100559.png"></p>
<h1 id="相关函数说明"><a href="#相关函数说明" class="headerlink" title="相关函数说明"></a>相关函数说明</h1><h2 id="Tensor-eval"><a href="#Tensor-eval" class="headerlink" title="Tensor.eval()"></a>Tensor.eval()</h2><p>.eval() 其实就是tf.Tensor的Session.run() 的另外一种写法，但两者有差别</p>
<ol>
<li>eval(): 将字符串string对象转化为有效的表达式参与求值运算返回计算结果</li>
<li>eval()也是启动计算的一种方式。基于Tensorflow的基本原理，首先需要定义图，然后计算图，其中计算图的函数常见的有run()函数，如sess.run()。同样eval()也是此类函数，</li>
<li>要注意的是，eval()只能用于tf.Tensor类对象，也就是有输出的Operation，写作Tensor.eval()。对于没有输出的Operation, 可以用.run()或者Session.run()；Session.run()没有这个限制。</li>
</ol>
<h2 id="np-argsort"><a href="#np-argsort" class="headerlink" title="np.argsort()"></a>np.argsort()</h2><p>argsort函数返回的是数组值从小到大的索引值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = np.array([<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>np.argsort(x)</span><br><span class="line">array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<h2 id="tf-reduce-sum"><a href="#tf-reduce-sum" class="headerlink" title="tf.reduce_sum()"></a>tf.reduce_sum()</h2><p>reduce_sum( ) 是求和函数，在 tensorflow 里面，计算的都是 tensor，可以通过调整 axis =0,1 的维度来控制求和维度。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = tf.constant([[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>],[<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>]])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tf.reduce_sum(x)</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tf.reduce_sum(x, <span class="number">0</span>)</span><br><span class="line">[<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tf.reduce_sum(x, <span class="number">1</span>)</span><br><span class="line">[<span class="number">3</span>,<span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tf.reduce_sum(x, <span class="number">1</span>, keepdims=<span class="keyword">True</span>)</span><br><span class="line">[[<span class="number">3</span>],[<span class="number">3</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tf.reduce_sum(x, [<span class="number">0</span>,<span class="number">1</span>])</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>

<h2 id="tf-nn-nce-loss"><a href="#tf-nn-nce-loss" class="headerlink" title="tf.nn.nce_loss()"></a>tf.nn.nce_loss()</h2><p>假设nce_loss之前的输入数据是K维的，一共有N个类，那么</p>
<p>weight.shape = (N, K)</p>
<p>bias.shape = (N)</p>
<p>inputs.shape = (batch_size, K)</p>
<p>labels.shape = (batch_size, num_true)</p>
<p>num_true : 实际的正样本个数</p>
<p>num_sampled: 采样出多少个负样本</p>
<p>num_classes = N</p>
<p>sampled_values: 采样出的负样本，如果是None，就会用不同的sampler去采样。待会儿说sampler是什么。</p>
<p>remove_accidental_hits: 如果采样时不小心采样到的负样本刚好是正样本，要不要干掉</p>
<p>partition_strategy：对weights进行embedding_lookup时并行查表时的策略。TF的embeding_lookup是在CPU里实现的，这里需要考虑多线程查表时的锁的问题</p>
<p>nce_loss的实现逻辑如下：</p>
<p>_compute_sampled_logits: 通过这个函数计算出正样本和采样出的负样本对应的output和label</p>
<p>sigmoid_cross_entropy_with_logits: 通过 sigmoid cross entropy来计算output和label的loss，从而进行反向传播。这个函数把最后的问题转化为了num_sampled+num_real个两类分类问题，然后每个分类问题用了交叉熵的损伤函数，也就是logistic regression常用的损失函数。TF里还提供了一个softmax_cross_entropy_with_logits的函数，和这个有所区别。</p>
<p>在训练过程中，作为input的embed也会被自动更新</p>
<h2 id="tf-nn-embedding-lookup"><a href="#tf-nn-embedding-lookup" class="headerlink" title="tf.nn.embedding_lookup()"></a>tf.nn.embedding_lookup()</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Signature:</span></span><br><span class="line">tf.nn.embedding_lookup(params, ids, partition_strategy=<span class="string">'mod'</span>, name=<span class="keyword">None</span>, validate_indices=<span class="keyword">True</span>, max_norm=<span class="keyword">None</span>)</span><br><span class="line"><span class="comment"># Docstring:</span></span><br><span class="line"><span class="comment"># Looks up `ids` in a list of embedding tensors.</span></span><br></pre></td></tr></table></figure>

<p>是根据 ids 中的id，寻找 params 中的第id行。比如 ids=[1,3,5]，则找出params中第1，3，5行，组成一个tensor返回。</p>
<p>embedding_lookup不是简单的查表，params 对应的向量是可以训练的，训练参数个数应该是 feature_num * embedding_size，即前文表述的embedding层权重矩阵，就是说 lookup 的是一种全连接层。</p>
<p>partition_strategy 为张量编号方式，在张量存在多维时起作用，编号的方式有两种，”mod”（默认） 和 “div”。</p>
<p>假设：一共有三个tensor [a,b,c] 作为params 参数，所有tensor的第 0 维上一共有 10 个项目（id 0 ~ 9）。</p>
<p>“mod” : (id) mod len(params) 得到 多少就把 id 分到第几个tensor里面</p>
<ul>
<li>a 依次分到id： 0 3 6 9</li>
<li>b 依次分到id： 1 4 7</li>
<li>c 依次分到id： 2 5 8</li>
</ul>
<p>“div” : (id) div len(params) 可以理解为依次排序，但是这两种切分方式在无法均匀切分的情况下都是将前(max_id+1)%len(params)个 partition 多分配一个元素.</p>
<ul>
<li>a 依次分到id： 0 1 2 3</li>
<li>b 依次分到id： 4 5 6</li>
<li>c 依次分到id： 7 8 9</li>
</ul>
<h2 id="tf-SparseTensor"><a href="#tf-SparseTensor" class="headerlink" title="tf.SparseTensor()"></a>tf.SparseTensor()</h2><p>构造稀疏向量矩阵，每一行为一个样本</p>
<p>SparseTensor(indices, values, dense_shape)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SparseTensor(indices=[[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">1</span>, <span class="number">2</span>]], values=[<span class="number">1</span>, <span class="number">2</span>], dense_shape=[<span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># represents the dense tensor</span></span><br><span class="line"></span><br><span class="line">[[<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>]</span><br><span class="line"> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>reference:<br><a href="https://blog.csdn.net/qoopqpqp/article/details/76037334" target="_blank" rel="noopener">https://blog.csdn.net/qoopqpqp/article/details/76037334</a><br><a href="https://segmentfault.com/a/1190000015287066?utm_source=tag-newest" target="_blank" rel="noopener">https://segmentfault.com/a/1190000015287066?utm_source=tag-newest</a><br><a href="https://blog.csdn.net/u012193416/article/details/83349138" target="_blank" rel="noopener">https://blog.csdn.net/u012193416/article/details/83349138</a><br><a href="https://blog.csdn.net/qq_36092251/article/details/79684721" target="_blank" rel="noopener">https://blog.csdn.net/qq_36092251/article/details/79684721</a><br><a href="https://gshtime.github.io/2018/06/01/tensorflow-embedding-lookup-sparse/" target="_blank" rel="noopener">https://gshtime.github.io/2018/06/01/tensorflow-embedding-lookup-sparse/</a></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://imonce.github.io/2019/10/10/一文读懂Curry-Howard同构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/C_Meng.png">
      <meta itemprop="name" content="C_Meng">
      <meta itemprop="description" content="This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="C_Meng PSNA">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/10/一文读懂Curry-Howard同构/" class="post-title-link" itemprop="url">一文读懂Curry-Howard同构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-10 10:42:29" itemprop="dateCreated datePublished" datetime="2019-10-10T10:42:29+08:00">2019-10-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-11-04 14:01:07" itemprop="dateModified" datetime="2019-11-04T14:01:07+08:00">2019-11-04</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/10/10/一文读懂Curry-Howard同构/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/10/10/一文读懂Curry-Howard同构/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
          
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>柯里-霍华德同构，Curry-Howard Isomorphism，又称柯里-霍华德对应（Curry-Howard correspondence）是在计算机程序和数学证明之间的紧密联系；这种对应也叫做公式为类型对应或命题为类型对应。这是对形式逻辑系统和公式计算（computational calculus）之间符号的相似性的推广。命名来自它的两位发现者：美国数学家哈斯凯尔·<strong>柯里</strong>和逻辑学家威廉·阿尔文·<strong>霍瓦德</strong>。</p>
<h1 id="同构对应"><a href="#同构对应" class="headerlink" title="同构对应"></a>同构对应</h1><p>Curry-Howard 同构显示了推理系统和程序语言之间的相似性，在此框架下：</p>
<ul>
<li>程序语言的语言构造同构为推理系统的推理规则</li>
<li>程序的类型同构为逻辑命题</li>
<li>闭合程序（不依赖环境的程序）可以同构为一条定理的证明过程，其类型就是一条定理</li>
<li>逻辑上下文同构为自由变量类型指派</li>
<li>Lambda 演算同构为 Gentzen 的自然演绎<ul>
<li>函数调用就是蕴含消除</li>
<li>函数抽象就是蕴含介入</li>
<li>参数多态就是全称量化</li>
<li>模板类型就是谓词</li>
<li>结构类型就是合取</li>
<li>联合类型就是析取</li>
<li>收参数但不返回就是否定</li>
<li>call/cc 就是双重否定消除</li>
</ul>
</li>
<li>SK 组合子演算同构为直觉 Hilbert 推理系统<ul>
<li>S 和 K 就是演算系统的两条公理</li>
</ul>
</li>
</ul>
<h1 id="Curry-Howard-同构与-Martin-Lof-类型论系统"><a href="#Curry-Howard-同构与-Martin-Lof-类型论系统" class="headerlink" title="Curry-Howard 同构与 Martin-Löf 类型论系统"></a>Curry-Howard 同构与 Martin-Löf 类型论系统</h1><p>这个框架里灵活性最高的是 Martin-Löf 的系统，两个高度抽象的算子—— $\prod$ 和 $\sum$ 进一步泛化了函数调用与合取，这使得它有极其恐怖的抽象能力。这个系统的推理规则是一下几条：</p>
<h2 id="Introduction-rule-for-prod"><a href="#Introduction-rule-for-prod" class="headerlink" title="Introduction rule for $\prod$"></a>Introduction rule for $\prod$</h2><p>$$\frac{\Gamma,x:A\vdash b:B}{\Gamma\vdash\lambda x.b:(\prod x:A)B}(\prod I)$$</p>
<h2 id="Elimination-rule-for-prod"><a href="#Elimination-rule-for-prod" class="headerlink" title="Elimination rule for $\prod$"></a>Elimination rule for $\prod$</h2><p>$$\frac{\Gamma\vdash f:(\prod x:A)B\quad\Gamma\vdash a:A}{\Gamma\vdash apply(f,a):B[a/x]}(\prod E)$$</p>
<p>Suppose $f = \lambda x.x$, then $apply(f,a)=(\lambda x.x)a$ </p>
<h2 id="Introduction-rule-for-sum"><a href="#Introduction-rule-for-sum" class="headerlink" title="Introduction rule for $\sum$"></a>Introduction rule for $\sum$</h2><p>$$\frac{\Gamma\vdash a:A\quad\Gamma\vdash b:B[a/x]}{\Gamma\vdash\lt a,b\gt:(\sum x:A)B}(\sum I)$$</p>
<h2 id="Elimination-rule-for-sum"><a href="#Elimination-rule-for-sum" class="headerlink" title="Elimination rule for $\sum$"></a>Elimination rule for $\sum$</h2><p>$$\frac{\Gamma\vdash c:(\sum x:A)B\quad\Gamma,x:A,y:B\vdash d:C[\lt x,y\gt/z]}{\Gamma\vdash split(c,\lambda x.\lambda y.d):C[c/z]}(\sum E)$$</p>
<p>where: $split(\lt a,b\gt,\lambda x.\lambda y.d)=(\lambda x.\lambda y.d)(a)(b)$ </p>
<blockquote>
<p>reference<br><a href="https://www.zhihu.com/question/22959608/answer/24770830" target="_blank" rel="noopener">https://www.zhihu.com/question/22959608/answer/24770830</a><br><a href="https://zh.wikipedia.org/zh-hans/%E6%9F%AF%E9%87%8C-%E9%9C%8D%E5%8D%8E%E5%BE%B7%E5%90%8C%E6%9E%84" target="_blank" rel="noopener">https://zh.wikipedia.org/zh-hans/柯里-霍华德同构</a><br><a href="http://www2.math.uu.se/~palmgren/tillog/klogik04-01eng.pdf" target="_blank" rel="noopener">http://www2.math.uu.se/~palmgren/tillog/klogik04-01eng.pdf</a></p>
</blockquote>

          
          
          
          
          
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="C_Meng"
      src="/images/C_Meng.png">
  <p class="site-author-name" itemprop="name">C_Meng</p>
  <div class="site-description" itemprop="description">This site is primarily used for personal note-taking, and some content are from open access, with sources clearly indicated. If there are any copyright issues, please feel free to contact us. 本站主要用于个人笔记记录，存在部分内容引用，均已表明出处，如存在版权问题，敬请联系。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">215</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/imonce" title="GitHub → https://github.com/imonce" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imonce@outlook.com" title="E-Mail → mailto:imonce@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/3912390829/profile?topnav=1&wvr=6&is_all=1" title="Weibo → https://weibo.com/3912390829/profile?topnav=1&wvr=6&is_all=1" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/moescee" title="Twitter → https://twitter.com/moescee" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-1831623022964098"
     data-ad-slot="5648729926"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">C_Meng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1279293837&web_id=1279293837"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  <script src="/js/local-search.js"></script>








<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'hBUFmUyAMBRRHULc0Y4SPPzw-gzGzoHsz',
      appKey     : 'WBQPPWjmwGWqvQcLqprPq0xs',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
